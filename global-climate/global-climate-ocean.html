<meta http-equiv="content-type" content="text/html; charset=UTF8">
<html>
  <head>
    <title>AgentScript Model</title>
    <script src="../lib/agentscript/agentscript.js"></script>
    <script src="../lib/agentscript/coffee-script.js"></script>
    <link href="http://code.jquery.com/ui/1.10.3/themes/smoothness/jquery-ui.css" rel="stylesheet" type="text/css" />
    <link href="//netdna.bootstrapcdn.com/font-awesome/3.0.2/css/font-awesome.css" rel="stylesheet">
    <link href="css/global-climate.css" rel="stylesheet" type="text/css" />
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.0/jquery.min.js"></script>
    <script src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.10.0/jquery-ui.min.js"></script>
    <script src="http://lab.concord.org/vendor/d3/d3.js"></script>
    <script src="../lib/lab.grapher.js"></script>
    <script type="text/coffeescript" src="global-climate-model.coffee"></script>
    <script type="text/coffeescript" src="global-climate-model-ocean.coffee"></script>
    <script type="text/javascript">
      var modelLoaded = $.Deferred(),
          oceanModelLoaded = $.Deferred();

      $(function() {
        $("button").button();
        $("#playback").buttonset();
        $(".icon-pause").hide();
      });

      $.when(modelLoaded, oceanModelLoaded).done(function() {
        climateModel = new OceanClimateModel("layers", 12, -24, 24, -15, 15, true);
        climateModel.setup();
        setupControls();
      });
    </script>
  </head>
  <body>
    <div id="content">
      <div id="model">
        <canvas id="canvas" >Your browser does not support HTML5 Canvas.</canvas>
        <div id="layers"></div>
      </div>
      <div id="controls">
        <div id='temperature-graph' class="graph"></div>
        <div id='co2-graph' class="graph"></div>
        <ul>
          <li>
            <button id="add-co2-button">Add CO2</button>
            <button id="subtract-co2-button">Subtract CO2</button>
          </li>
          <li>
            <span id="co2-output" class="output digits3"></span>
          </li>
          <li class="output">
            Temperature: <span id="temperature-output"></span>
          </li>
        </ul>
        <ul>
          <li>
            <label for="albedo-slider">Albedo:</label>
            <span class="slider-units">0 <input id="albedo-slider" type="range" min="0" max="1" step="0.01"/> 1</span>
          </li>
        </ul>
        <ul>
          <li>
            <label for="sun-brightness-slider">Sun Brightness:</label>
            <span class="slider-units">0 <input id="sun-brightness-slider" type="range" min="0" max="200" step="1"/> 200</span>
          </li>
        </ul>
        <ul>
          <li>
            <button id="add-clouds-button">Add Cloud</button>
            <button id="subtract-clouds-button">Subtract Cloud</button>
          </li>
          <li>
            <span id="co2-output" class="output digits3"></span>
          </li>
        </ul>
        <ul>
          <li>
            <button id="follow-sunray-button">Follow Energy Packet</button>
            <button id="follow-co2-button">Follow CO2</button>
          </li>
        </ul>
        <ul>
          <li>
            <button id="hide-button">Hide 90% of elements</button>
          </li>
        </ul>
      </div>
      <div id="playback-controls">
        <div id="playback">
          <button id="reset-button">
            <i class="icon-step-backward"></i>
          </button>
          <button id="play-pause-button">
            <i class="icon-play"></i>
            <i class="icon-pause"></i>
          </button>
        </div>
      </div>
      <div id="show-agent-controls">
        Show:
        <div class="checkbox">
          <input type="checkbox" value="None" id="showGases" name="check" checked/>
          <label for="showGases"></label>
          <span>Gases</span>
        </div>
        <div class="checkbox">
          <input type="checkbox" value="None" id="showRays" name="check" checked/>
          <label for="showRays"></label>
          <span>Rays</span>
        </div>
        <div class="checkbox">
          <input type="checkbox" value="None" id="showHeat" name="check" checked/>
          <label for="showHeat"></label>
          <span>Heat</span>
        </div>
      <div id="year-box">
        Year: <span id="year"></span>
      </div>
    </div>
      <div id="year-box">
        Year: <span id="year"></span>
      </div>
    </div>
    <script>
      var addCO2Button = document.getElementById("add-co2-button"),
          subtractCO2Button = document.getElementById("subtract-co2-button"),
          albedoSlider = document.getElementById("albedo-slider"),
          sunBrightnessSlider = document.getElementById("sun-brightness-slider"),
          co2Output = document.getElementById("co2-output"),
          temperatureOutput = document.getElementById("temperature-output"),
          addCloudsButton = document.getElementById("add-clouds-button"),
          subtractCloudsButton = document.getElementById("subtract-clouds-button"),
          followSunrayButton = document.getElementById("follow-sunray-button"),
          followCO2Button = document.getElementById("follow-co2-button"),
          yearCounter = document.getElementById("year"),
          temperatureFormatter = d3.format("3.1f"),
          countFormatter = d3.format("3f"),
          ticks = 0,
          lastTick = 0,
          temperatureGraph,
          co2Graph;

      function setupControls() {
        albedoSlider.value = climateModel.getAlbedo();
        sunBrightnessSlider.value = climateModel.getSunBrightness();
      }

      addCO2Button.onclick = function() {
        climateModel.addCO2();
      }

      subtractCO2Button.onclick = function() {
        climateModel.subtractCO2();
      }

      addCloudsButton.onclick = function() {
        climateModel.addCloud();
      }

      subtractCloudsButton.onclick = function() {
        climateModel.subtractCloud();
      }

      followSunrayButton.onclick = function() {
        climateModel.addSunraySpotlight();
      }

      followCO2Button.onclick = function() {
        if (this.textContent === "Follow CO2") {
          climateModel.addCO2Spotlight();
          this.textContent = "Stop following";
        } else {
          climateModel.removeSpotlight();
          this.textContent = "Follow CO2";
        }
      }

      $('#hide-button').click(function() {
        $span = $(this).find("span");
        if ($span.text() === "Hide 90% of elements") {
          climateModel.hide90();
          $span.text("Show all elements");
        } else {
          climateModel.showAll();
          $span.text("Hide 90% of elements");
        }
      });

      albedoSlider.onchange = function() {
        climateModel.setAlbedo(+albedoSlider.value);
      }

      sunBrightnessSlider.onchange = function() {
        climateModel.setSunBrightness(+sunBrightnessSlider.value);
      }

      $('#play-pause-button').click(function() {
        if (climateModel.anim.animStop) {
          climateModel.start();
          $(".icon-pause").show();
          $(".icon-play").hide();
        } else {
          climateModel.stop();
          $(".icon-pause").hide();
          $(".icon-play").show();
        }
      });

      $('#reset-button').click(function() {
        climateModel.stop();
        $(".icon-pause").hide();
        $(".icon-play").show();
        lastTick = 0;
        temperatureGraph.reset();
        co2Graph.reset();
        climateModel.setup();
      });

      $('#show-agent-controls input').click(function() {
        var $this   = $(this),
            func    = $this.attr('id'),
            checked = $this.is(':checked');
        climateModel[func](checked);
      });

      function updateTickCounter() {
        yearCounter.textContent = climateModel.getYear();
      }

      temperatureGraph = Lab.grapher.Graph('#temperature-graph',
        {
          title:  "Temperature vs Time",
          xlabel: "Time (year)",
          ylabel: "Temperature",
          xmax:   2020,
          xmin:   2013,
          ymax:   40,
          ymin:   -10,
          xTickCount: 4,
          yTickCount: 5,
          xFormatter: "d",
          dataSampleStart: 2013,
          sampleInterval: 1/300,
          realTime: true,
          fontScaleRelativeToParent: true
        });

      co2Graph = Lab.grapher.Graph('#co2-graph',
        {
          title:  "Air CO2 (red), Ocean CO2 (green), Vapor (blue) vs Time",
          xlabel: "Time (year)",
          ylabel: "Greenhouse gases",
          xmax:   2020,
          xmin:   2013,
          ymax:   30,
          ymin:   0,
          xTickCount: 4,
          yTickCount: 5,
          xFormatter: "d",
          dataSampleStart: 2013,
          sampleInterval: 1/300,
          realTime: false,
          fontScaleRelativeToParent: true
        });

      lastTick = 0;

      d3.timer(function(elapsed) {
        if (typeof climateModel !== "undefined") {
          var temperature = climateModel.getTemperature(),
              atmosphereCO2Count = climateModel.getAtmosphereCO2Count(),
              oceanCO2Count = climateModel.getOceanCO2Count(),
              vaporCount = climateModel.getVaporCount(),
              tick = climateModel.anim.ticks,
              ticksElapsed = tick - lastTick;
          temperatureOutput.textContent = temperatureFormatter(temperature);
          co2Output.textContent = countFormatter(atmosphereCO2Count);
          if (!climateModel.animStop && ticksElapsed) {
            while (ticksElapsed--) {  // duplicate data if multiple model steps passed
              temperatureGraph.addSamples([temperature]);
              co2Graph.addSamples([atmosphereCO2Count, oceanCO2Count, vaporCount]);
            }
            updateTickCounter();
            lastTick = tick;
          }
        }
      });

    </script>
  </body>
</html>
