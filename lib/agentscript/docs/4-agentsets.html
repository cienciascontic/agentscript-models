<!DOCTYPE html>

<html>
<head>
  <title>4-agentsets.coffee</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="1-util.html">
                1-util.coffee
              </a>
            
              
              <a class="source" href="2-shapes.html">
                2-shapes.coffee
              </a>
            
              
              <a class="source" href="3-agentset.html">
                3-agentset.coffee
              </a>
            
              
              <a class="source" href="4-agentsets.html">
                4-agentsets.coffee
              </a>
            
              
              <a class="source" href="5-model.html">
                5-model.coffee
              </a>
            
              
              <a class="source" href="6-template.html">
                6-template.coffee
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>4-agentsets.coffee</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <p>There are three agentsets and their corresponding
agents: Patches/Patch, Agents/Agent, and Links/Link.</p>

            </div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <h3 id="patch-and-patches">Patch and Patches</h3>

            </div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>Class Patch instances represent a rectangle on a grid with:</p>
<ul>
<li>id: installed by Patches agentset</li>
<li>x,y: the x,y position within the grid</li>
<li>color: the color of the patch as an RGBA array, A optional.</li>
<li>hidden: whether or not to draw this patch</li>
<li>label: text for the patch</li>
<li>n/n4: adjacent neighbors: n: 8 patches [SW, S , SE, W, E, NW, N, NE], n4: 4 patches [S, W, E, N].</li>
<li>breed: the agentset this patch belongs to</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ABM</span>.<span class="hljs-title">Patch</span></span></pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>Patches may not need their neighbors, thus we use a default
of none.  n and n4 are promoted by the Patches agent set
if world.neighbors is true, the default.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">n</span>: <span class="hljs-literal">null</span>
  <span class="hljs-attribute">n4</span>: <span class="hljs-literal">null</span>
  <span class="hljs-attribute">color</span>: [<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>]
  <span class="hljs-attribute">hidden</span>: <span class="hljs-literal">false</span>
  <span class="hljs-attribute">label</span>: <span class="hljs-literal">null</span>
  <span class="hljs-attribute">breed</span>: <span class="hljs-literal">null</span> <span class="hljs-comment"># set by the agentSet owning this patch</span></pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>New Patch: Just set x,y. Neighbors set by Patches constructor if needed.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">constructor</span>: <span class="hljs-function"><span class="hljs-params">(<span class="hljs-property">@x</span>, <span class="hljs-property">@y</span>)</span> -&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>Return a string representation of the patch.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">toString</span>:<span class="hljs-function"> -&gt;</span>
    <span class="hljs-string">"{id:<span class="hljs-subst">#{<span class="hljs-property">@id</span>}</span> xy:<span class="hljs-subst">#{[<span class="hljs-property">@x</span>,<span class="hljs-property">@y</span>]}</span> c:<span class="hljs-subst">#{<span class="hljs-property">@color</span>}</span>}"</span></pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>Set patch color to <code>c</code> scaled by <code>s</code>. Usage:</p>
<pre><code>p.scaleColor p.color, <span class="hljs-number">.8</span> <span class="hljs-comment"># reduce patch color by .8</span>
p.scaleColor <span class="hljs-property">@foodColor</span>, p.foodPheromone <span class="hljs-comment"># ants model</span>
</code></pre><p>Promotes color if currently using the default.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">scaleColor</span>: <span class="hljs-function"><span class="hljs-params">(c, s)</span> -&gt;</span>
    <span class="hljs-property">@color</span> = u.clone <span class="hljs-property">@color</span> <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> @.hasOwnProperty(<span class="hljs-string">"color"</span>)
    u.scaleColor c, s, <span class="hljs-property">@color</span></pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>Draw the patch and its text label if there is one.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">draw</span>: <span class="hljs-function"><span class="hljs-params">(ctx)</span> -&gt;</span>
    ctx.fillStyle = u.colorStr <span class="hljs-property">@color</span>
    ctx.fillRect <span class="hljs-property">@x</span>-<span class="hljs-number">.5</span>, <span class="hljs-property">@y</span>-<span class="hljs-number">.5</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>
    <span class="hljs-property">@drawLabel</span>(ctx)

  <span class="hljs-attribute">drawLabel</span>: <span class="hljs-function"><span class="hljs-params">(ctx)</span>-&gt;</span>
    <span class="hljs-keyword">if</span> <span class="hljs-property">@label</span>? <span class="hljs-comment"># REMIND: should be 2nd pass.</span>
      [x,y] = ctx.labelXY
      ctx.save() <span class="hljs-comment"># bug: fonts don't scale for size &lt; 1</span>
      ctx.translate <span class="hljs-property">@x</span>, <span class="hljs-property">@y</span>
      ctx.scale <span class="hljs-number">1</span>/ABM.patches.size, -<span class="hljs-number">1</span>/ABM.patches.size <span class="hljs-comment"># revert to identity for text use</span>
      u.ctxDrawText ctx, <span class="hljs-property">@label</span>, [x,y], ctx.labelColor
      ctx.restore()</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>Return an array of the agents on this patch.
If patches.cacheAgentsHere has created an @agents instance
variable for the patches, agents will add/remove themselves
as they move from patch to patch.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">agentsHere</span>:<span class="hljs-function"> -&gt;</span>
    <span class="hljs-property">@agents</span> ? (a <span class="hljs-keyword">for</span> a <span class="hljs-keyword">in</span> ABM.agents <span class="hljs-keyword">when</span> a.p <span class="hljs-keyword">is</span> @)</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>Returns true if this patch is on the edge of the grid.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">isOnEdge</span>:<span class="hljs-function"> -&gt;</span>
    <span class="hljs-property">@x</span> <span class="hljs-keyword">is</span> ABM.patches.minX <span class="hljs-keyword">or</span> <span class="hljs-property">@x</span> <span class="hljs-keyword">is</span> ABM.patches.maxX <span class="hljs-keyword">or</span> \
    <span class="hljs-property">@y</span> <span class="hljs-keyword">is</span> ABM.patches.minY <span class="hljs-keyword">or</span> <span class="hljs-property">@y</span> <span class="hljs-keyword">is</span> ABM.patches.maxY</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>Factory: Create num new agents on this patch. The optional init
proc is called on the new agent after inserting in its agentSet.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">sprout</span>: <span class="hljs-function"><span class="hljs-params">(num = <span class="hljs-number">1</span>, breed = ABM.agents, init = -&gt;)</span> -&gt;</span>
    breed.create num, <span class="hljs-function"><span class="hljs-params">(a)</span> =&gt;</span> <span class="hljs-comment"># fat arrow so that @ = this patch</span>
      a.setXY <span class="hljs-property">@x</span>, <span class="hljs-property">@y</span>; init(a); a</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>Class Patches is a singleton 2D matrix of Patch instances, each patch
representing a 1x1 square in patch coordinates (via 2D coord transforms).</p>
<p>From ABM.world, set in Model:</p>
<ul>
<li>size: pixel h/w of each patch.</li>
<li>minX/maxX: min/max x coord in patch coords</li>
<li>minY/maxY: min/max y coord in patch coords</li>
<li>numX/numY: width/height of grid.</li>
<li>isTorus: true if coord system wraps around at edges</li>
<li>hasNeighbors: true if each patch caches its neighbors</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ABM</span>.<span class="hljs-title">Patches</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">ABM</span>.<span class="hljs-title">AgentSet</span></span></pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>Constructor: super creates the empty AgentSet instance and installs
the agentClass (breed) variable shared by all the Patches in this set.
Patches are created from top-left to bottom-right to match data sets.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">constructor</span>:<span class="hljs-function"> -&gt;</span> <span class="hljs-comment"># agentClass, name, mainSet</span>
    <span class="hljs-keyword">super</span> <span class="hljs-comment"># call super with all the args I was called with</span>
    @[k] = v <span class="hljs-keyword">for</span> own k,v <span class="hljs-keyword">of</span> ABM.world <span class="hljs-comment"># add world items to patches</span>
    <span class="hljs-keyword">for</span> y <span class="hljs-keyword">in</span> [<span class="hljs-property">@maxY</span>..<span class="hljs-property">@minY</span>] <span class="hljs-keyword">by</span> -<span class="hljs-number">1</span>
      <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> [<span class="hljs-property">@minX</span>..<span class="hljs-property">@maxX</span>] <span class="hljs-keyword">by</span> <span class="hljs-number">1</span>
        <span class="hljs-property">@add</span> <span class="hljs-keyword">new</span> ABM.Patch x, y
    <span class="hljs-property">@setNeighbors</span>() <span class="hljs-keyword">if</span> <span class="hljs-property">@hasNeighbors</span>
    <span class="hljs-property">@setPixels</span>()
    <span class="hljs-property">@drawWithPixels</span> = <span class="hljs-property">@size</span> <span class="hljs-keyword">is</span> <span class="hljs-number">1</span> <span class="hljs-comment"># if size is 1, default to true, otherwise false</span></pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>Set the default color for new Patch instances.
Note coffeescript :: which refers to the Patch prototype.
This is the usual way to modify class variables.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">setDefaultColor</span>: <span class="hljs-function"><span class="hljs-params">(color)</span> -&gt;</span> ABM.<span class="hljs-attribute">Patch</span>::color = color</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>Have patches cache the agents currently on them.
Optimizes p.agentsHere method.
Call before first agent is created.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">cacheAgentsHere</span>:<span class="hljs-function"> -&gt;</span> p.agents = [] <span class="hljs-keyword">for</span> p <span class="hljs-keyword">in</span> @; <span class="hljs-literal">null</span></pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>Draw patches using scaled image of colors. Note anti-aliasing may occur
if browser does not support these flags.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">usePixels</span>: <span class="hljs-function"><span class="hljs-params">(usePix=<span class="hljs-literal">true</span>)</span> -&gt;</span>
    ctx = ABM.contexts.patches
    ctx.imageSmoothingEnabled = <span class="hljs-keyword">not</span> usePix
    ctx.mozImageSmoothingEnabled = <span class="hljs-keyword">not</span> usePix
    ctx.webkitImageSmoothingEnabled = <span class="hljs-keyword">not</span> usePix
    u.setIdentity ctx
    <span class="hljs-property">@drawWithPixels</span> = usePix</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>Optimization: Cache a single set by modeler for use by patchRect,
inCone, inRect, inRadius.  Ex: flock demo model’s vision rect.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">cacheRect</span>: <span class="hljs-function"><span class="hljs-params">(radius, meToo=<span class="hljs-literal">false</span>)</span> -&gt;</span>
    <span class="hljs-keyword">for</span> p <span class="hljs-keyword">in</span> @
      p.pRect = <span class="hljs-property">@patchRect</span> p, radius, radius, meToo
      p.pRect.radius = radius; p.pRect.meToo = meToo</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>Install neighborhoods in patches</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">setNeighbors</span>:<span class="hljs-function"> -&gt;</span>
    <span class="hljs-keyword">for</span> p <span class="hljs-keyword">in</span> @
      p.n =  <span class="hljs-property">@patchRect</span> p, <span class="hljs-number">1</span>, <span class="hljs-number">1</span> <span class="hljs-comment"># p.n =  p.patchRect 1, 1</span>
      p.n4 = [ p.n[<span class="hljs-number">1</span>], p.n[<span class="hljs-number">3</span>], p.n[<span class="hljs-number">4</span>], p.n[<span class="hljs-number">6</span>] ]</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>Setup pixels used for <code>drawScaledPixels</code> and <code>importColors</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">setPixels</span>:<span class="hljs-function"> -&gt;</span>
    <span class="hljs-keyword">if</span> <span class="hljs-property">@size</span> <span class="hljs-keyword">is</span> <span class="hljs-number">1</span>
      <span class="hljs-property">@pixelsCtx</span> = ABM.contexts.patches
    <span class="hljs-keyword">else</span>
      can = <span class="hljs-built_in">document</span>.createElement <span class="hljs-string">'canvas'</span>  <span class="hljs-comment"># small pixel grid for patch colors</span>
      can.width = <span class="hljs-property">@numX</span>; can.height = <span class="hljs-property">@numY</span>
      <span class="hljs-property">@pixelsCtx</span> = can.getContext <span class="hljs-string">"2d"</span>
    <span class="hljs-property">@pixelsImageData</span> = <span class="hljs-property">@pixelsCtx</span>.getImageData(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-property">@numX</span>, <span class="hljs-property">@numY</span>)
    <span class="hljs-property">@pixelsData</span> = <span class="hljs-property">@pixelsImageData</span>.data
    <span class="hljs-keyword">if</span> <span class="hljs-property">@pixelsData</span> <span class="hljs-keyword">instanceof</span> Uint8Array <span class="hljs-comment"># Check for typed arrays</span>
      <span class="hljs-property">@pixelsData32</span> = <span class="hljs-keyword">new</span> Uint32Array <span class="hljs-property">@pixelsData</span>.buffer
      <span class="hljs-property">@pixelsAreLittleEndian</span> = u.isLittleEndian()</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>If using scaled pixels, use pixel manipulation below, or use default agentSet
draw which iterates over the patches, drawing rectangles.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">draw</span>: <span class="hljs-function"><span class="hljs-params">(ctx)</span> -&gt;</span> <span class="hljs-keyword">if</span> <span class="hljs-property">@drawWithPixels</span> <span class="hljs-keyword">then</span> <span class="hljs-property">@drawScaledPixels</span> ctx <span class="hljs-keyword">else</span> <span class="hljs-keyword">super</span> ctx</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <h4 id="patch-grid-coord-system-utilities-">Patch grid coord system utilities:</h4>

            </div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>Return the patch id/index given integer x,y in patch coords</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">patchIndex</span>: <span class="hljs-function"><span class="hljs-params">(x,y)</span> -&gt;</span> x-<span class="hljs-property">@minX</span> + <span class="hljs-property">@numX</span>*(<span class="hljs-property">@maxY</span>-y)</pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>Return the patch at matrix position x,y where
x &amp; y are both valid integer patch coordinates.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">patchXY</span>: <span class="hljs-function"><span class="hljs-params">(x,y)</span> -&gt;</span> @[<span class="hljs-property">@patchIndex</span> x,y]</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p>Return x,y float values to be between min/max patch coord values</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">clamp</span>: <span class="hljs-function"><span class="hljs-params">(x,y)</span> -&gt;</span> [u.clamp(x, <span class="hljs-property">@minX</span>-<span class="hljs-number">.5</span>, <span class="hljs-property">@maxX</span>+<span class="hljs-number">.5</span>), u.clamp(y, <span class="hljs-property">@minY</span>-<span class="hljs-number">.5</span>, <span class="hljs-property">@maxY</span>+<span class="hljs-number">.5</span>)]</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p>Return x,y float values to be modulo min/max patch coord values.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">wrap</span>: <span class="hljs-function"><span class="hljs-params">(x,y)</span>  -&gt;</span> [u.wrap(x, <span class="hljs-property">@minX</span>-<span class="hljs-number">.5</span>, <span class="hljs-property">@maxX</span>+<span class="hljs-number">.5</span>),  u.wrap(y, <span class="hljs-property">@minY</span>-<span class="hljs-number">.5</span>, <span class="hljs-property">@maxY</span>+<span class="hljs-number">.5</span>)]</pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p>Return x,y float values to be between min/max patch values
using either clamp/wrap above according to isTorus topology.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">coord</span>: <span class="hljs-function"><span class="hljs-params">(x,y)</span> -&gt;</span> <span class="hljs-comment">#returns a valid world coord (real, not int)</span>
    <span class="hljs-keyword">if</span> <span class="hljs-property">@isTorus</span> <span class="hljs-keyword">then</span> <span class="hljs-property">@wrap</span> x,y <span class="hljs-keyword">else</span> <span class="hljs-property">@clamp</span> x,y</pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <p>Return patch at x,y float values according to topology.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">patch</span>: <span class="hljs-function"><span class="hljs-params">(x,y)</span> -&gt;</span>
    [x,y]=<span class="hljs-property">@coord</span> x,y
    x = u.clamp Math.round(x), <span class="hljs-property">@minX</span>, <span class="hljs-property">@maxX</span>
    y = u.clamp Math.round(y), <span class="hljs-property">@minY</span>, <span class="hljs-property">@maxY</span>
    <span class="hljs-property">@patchXY</span> x, y</pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <p>Return the patch at the pixel location indicated.
x/y are screen coordinates (ie 0,0 is top left of the canvas, and values
increase positively downward and to the right).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">patchAtPixel</span>: <span class="hljs-function"><span class="hljs-params">(x,y)</span>-&gt;</span>
    x = Math.floor(x/<span class="hljs-property">@size</span>) + <span class="hljs-property">@minX</span>
    y = <span class="hljs-property">@maxY</span> - Math.floor(y/<span class="hljs-property">@size</span>)
    x = u.clamp x, <span class="hljs-property">@minX</span>, <span class="hljs-property">@maxX</span>
    y = u.clamp y, <span class="hljs-property">@minY</span>, <span class="hljs-property">@maxY</span>
    <span class="hljs-keyword">return</span> <span class="hljs-property">@patchXY</span> x, y</pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <p>Return a random valid float x,y point in patch space</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">randomPt</span>:<span class="hljs-function"> -&gt;</span> [u.randomFloat2(<span class="hljs-property">@minX</span>-<span class="hljs-number">.5</span>,<span class="hljs-property">@maxX</span>+<span class="hljs-number">.5</span>), u.randomFloat2(<span class="hljs-property">@minY</span>-<span class="hljs-number">.5</span>,<span class="hljs-property">@maxY</span>+<span class="hljs-number">.5</span>)]</pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <h4 id="patch-metrics">Patch metrics</h4>

            </div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <p>Convert patch measure to pixels</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">toBits</span>: <span class="hljs-function"><span class="hljs-params">(p)</span> -&gt;</span> p*<span class="hljs-property">@size</span></pre></div></div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <p>Convert bit measure to patches</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">fromBits</span>: <span class="hljs-function"><span class="hljs-params">(b)</span> -&gt;</span> b/<span class="hljs-property">@size</span></pre></div></div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              <h4 id="patch-utilities">Patch utilities</h4>

            </div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
              <p>Return an array of patches in a rectangle centered on the given
patch <code>p</code>, dx, dy units to the right/left and up/down.
Exclude <code>p</code> unless meToo is true, default false.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">patchRect</span>: <span class="hljs-function"><span class="hljs-params">(p, dx, dy, meToo=<span class="hljs-literal">false</span>)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> p.pRect? <span class="hljs-keyword">and</span> p.pRect.radius <span class="hljs-keyword">is</span> dx <span class="hljs-comment"># and p.pRect.radius is dy</span>
      <span class="hljs-keyword">return</span> p.pRect
    rect = []; <span class="hljs-comment"># REMIND: optimize if no wrapping, rect inside patch boundaries</span>
    <span class="hljs-keyword">for</span> y <span class="hljs-keyword">in</span> [p.y-dy..p.y+dy] <span class="hljs-keyword">by</span> <span class="hljs-number">1</span> <span class="hljs-comment"># by 1: perf: avoid bidir JS for loop</span>
      <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> [p.x-dx..p.x+dx] <span class="hljs-keyword">by</span> <span class="hljs-number">1</span>
        <span class="hljs-keyword">if</span> <span class="hljs-property">@isTorus</span> <span class="hljs-keyword">or</span> (<span class="hljs-property">@minX</span>&lt;=x&lt;=<span class="hljs-property">@maxX</span> <span class="hljs-keyword">and</span> <span class="hljs-property">@minY</span>&lt;=y&lt;=<span class="hljs-property">@maxY</span>)
          <span class="hljs-keyword">if</span> <span class="hljs-property">@isTorus</span>
            x+=<span class="hljs-property">@numX</span> <span class="hljs-keyword">if</span> x&lt;<span class="hljs-property">@minX</span>; x-=<span class="hljs-property">@numX</span> <span class="hljs-keyword">if</span> x&gt;<span class="hljs-property">@maxX</span>
            y+=<span class="hljs-property">@numY</span> <span class="hljs-keyword">if</span> y&lt;<span class="hljs-property">@minY</span>; y-=<span class="hljs-property">@numY</span> <span class="hljs-keyword">if</span> y&gt;<span class="hljs-property">@maxY</span>
          pnext = <span class="hljs-property">@patchXY</span> x, y <span class="hljs-comment"># much faster than coord()</span>
          <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> pnext?
            u.error <span class="hljs-string">"patchRect: x,y out of bounds, see console.log"</span>
            <span class="hljs-built_in">console</span>.log <span class="hljs-string">"x <span class="hljs-subst">#{x}</span> y <span class="hljs-subst">#{y}</span> p.x <span class="hljs-subst">#{p.x}</span> p.y <span class="hljs-subst">#{p.y}</span> dx <span class="hljs-subst">#{dx}</span> dy <span class="hljs-subst">#{dy}</span>"</span>
        <span class="hljs-keyword">else</span>
          pnext = <span class="hljs-literal">null</span>
        rect.push pnext <span class="hljs-keyword">if</span> (meToo <span class="hljs-keyword">or</span> p <span class="hljs-keyword">isnt</span> pnext)
    <span class="hljs-property">@asSet</span> rect</pre></div></div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-35">&#182;</a>
              </div>
              <p>Draws, or “imports” an image URL into the drawing layer.
The image is scaled to fit the drawing layer.</p>
<p>This is an async load, see this
<a href="http://javascript.mfields.org/2011/creating-an-image-in-javascript/">new Image()</a>
tutorial.  We draw the image into the drawing layer as
soon as the onload callback executes.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">installDrawing</span>: <span class="hljs-function"><span class="hljs-params">(img, ctx=ABM.contexts.drawing)</span> -&gt;</span>
    u.setIdentity ctx
    ctx.drawImage img, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, ctx.canvas.width, ctx.canvas.height
    ctx.restore() <span class="hljs-comment"># restore patch transform</span>
  <span class="hljs-attribute">importDrawing</span>: <span class="hljs-function"><span class="hljs-params">(imageSrc, f)</span> -&gt;</span>
    u.importImage imageSrc, <span class="hljs-function"><span class="hljs-params">(img)</span> -&gt;</span>
      ctx = ABM.drawing
      u.setIdentity ctx
      ctx.drawImage img, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, ctx.canvas.width, ctx.canvas.height
      ctx.restore() <span class="hljs-comment"># restore patch transform</span>
      f() <span class="hljs-keyword">if</span> f?</pre></div></div>
            
        </li>
        
        
        <li id="section-36">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-36">&#182;</a>
              </div>
              <p>Utility function for pixel manipulation.  Given a patch, returns the
native canvas index i into the pixel data.
The top-left order simplifies finding pixels in data sets</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">pixelByteIndex</span>: <span class="hljs-function"><span class="hljs-params">(p)</span> -&gt;</span> <span class="hljs-number">4</span>*p.id <span class="hljs-comment"># Uint8</span>
  <span class="hljs-attribute">pixelWordIndex</span>: <span class="hljs-function"><span class="hljs-params">(p)</span> -&gt;</span> p.id   <span class="hljs-comment"># Uint32</span></pre></div></div>
            
        </li>
        
        
        <li id="section-37">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-37">&#182;</a>
              </div>
              <p>Draws, or “imports” an image URL into the patches as their color property.
The drawing is scaled to the number of x,y patches, thus one pixel
per patch.  The colors are then transferred to the patches.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">installColors</span>: <span class="hljs-function"><span class="hljs-params">(img)</span> -&gt;</span>
    <span class="hljs-property">@pixelsCtx</span>.drawImage img, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-property">@numX</span>, <span class="hljs-property">@numY</span> <span class="hljs-comment"># scale if needed</span>
    data = <span class="hljs-property">@pixelsCtx</span>.getImageData(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-property">@numX</span>, <span class="hljs-property">@numY</span>).data
    <span class="hljs-keyword">for</span> p <span class="hljs-keyword">in</span> @
      i = <span class="hljs-property">@pixelByteIndex</span> p
      p.color = [data[i++], data[i++], data[i]] <span class="hljs-comment"># promote initial default</span>
  <span class="hljs-attribute">importColors</span>: <span class="hljs-function"><span class="hljs-params">(imageSrc, f)</span> -&gt;</span>
    u.importImage imageSrc, <span class="hljs-function"><span class="hljs-params">(img)</span> =&gt;</span> <span class="hljs-comment"># fat arrow, this context</span>
      <span class="hljs-property">@installColors</span>(img)
      f() <span class="hljs-keyword">if</span> f?</pre></div></div>
            
        </li>
        
        
        <li id="section-38">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-38">&#182;</a>
              </div>
              <p>Draw the patches via pixel manipulation rather than 2D drawRect.
See Mozilla pixel <a href="http://goo.gl/Lxliq">manipulation article</a></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">drawScaledPixels</span>: <span class="hljs-function"><span class="hljs-params">(ctx, pSet=@)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> <span class="hljs-property">@pixelsData32</span>?
      <span class="hljs-property">@drawScaledPixels32</span> ctx, pSet
    <span class="hljs-keyword">else</span>
      <span class="hljs-property">@drawScaledPixels8</span> ctx, pSet</pre></div></div>
            
        </li>
        
        
        <li id="section-39">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-39">&#182;</a>
              </div>
              <p>The 8-bit version for drawScaledPixels.  Used for systems w/o typed arrays</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">drawScaledPixels8</span>: <span class="hljs-function"><span class="hljs-params">(ctx, pSet)</span> -&gt;</span>
    data = <span class="hljs-property">@pixelsData</span>
    <span class="hljs-keyword">for</span> p <span class="hljs-keyword">in</span> pSet
      i = <span class="hljs-property">@pixelByteIndex</span> p
      c = p.color
      data[i+j] = c[j] <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> [<span class="hljs-number">0.</span><span class="hljs-number">.2</span>]
      data[i+<span class="hljs-number">3</span>] = <span class="hljs-keyword">if</span> c.length <span class="hljs-keyword">is</span> <span class="hljs-number">4</span> <span class="hljs-keyword">then</span> c[<span class="hljs-number">3</span>] <span class="hljs-keyword">else</span> <span class="hljs-number">255</span>
    <span class="hljs-property">@pixelsCtx</span>.putImageData(<span class="hljs-property">@pixelsImageData</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>)
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">if</span> <span class="hljs-property">@size</span> <span class="hljs-keyword">is</span> <span class="hljs-number">1</span>
    ctx.drawImage <span class="hljs-property">@pixelsCtx</span>.canvas, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, ctx.canvas.width, ctx.canvas.height</pre></div></div>
            
        </li>
        
        
        <li id="section-40">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-40">&#182;</a>
              </div>
              <p>The 32-bit version of drawScaledPixels, with both little and big endian hardware.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">drawScaledPixels32</span>: <span class="hljs-function"><span class="hljs-params">(ctx, pSet)</span> -&gt;</span>
    data = <span class="hljs-property">@pixelsData32</span>
    <span class="hljs-keyword">for</span> p <span class="hljs-keyword">in</span> pSet
      i = <span class="hljs-property">@pixelWordIndex</span> p
      c = p.color
      a = <span class="hljs-keyword">if</span> c.length <span class="hljs-keyword">is</span> <span class="hljs-number">4</span> <span class="hljs-keyword">then</span> c[<span class="hljs-number">3</span>] <span class="hljs-keyword">else</span> <span class="hljs-number">255</span>
      <span class="hljs-keyword">if</span> <span class="hljs-property">@pixelsAreLittleEndian</span>
        data[i] =
          (a    &lt;&lt; <span class="hljs-number">24</span>) |  <span class="hljs-comment"># alpha</span>
          (c[<span class="hljs-number">2</span>] &lt;&lt; <span class="hljs-number">16</span>) |  <span class="hljs-comment"># blue</span>
          (c[<span class="hljs-number">1</span>] &lt;&lt; <span class="hljs-number">8</span>)  |  <span class="hljs-comment"># green</span>
          c[<span class="hljs-number">0</span>];           <span class="hljs-comment"># red</span>
      <span class="hljs-keyword">else</span>
        data[i] =
          (c[<span class="hljs-number">0</span>] &lt;&lt; <span class="hljs-number">24</span>) |  <span class="hljs-comment"># red</span>
          (c[<span class="hljs-number">1</span>] &lt;&lt; <span class="hljs-number">16</span>) |  <span class="hljs-comment"># green</span>
          (c[<span class="hljs-number">2</span>] &lt;&lt; <span class="hljs-number">8</span>)  |  <span class="hljs-comment"># blue</span>
          a;              <span class="hljs-comment"># alpha</span>
    <span class="hljs-property">@pixelsCtx</span>.putImageData(<span class="hljs-property">@pixelsImageData</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>)
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">if</span> <span class="hljs-property">@size</span> <span class="hljs-keyword">is</span> <span class="hljs-number">1</span>
    ctx.drawImage <span class="hljs-property">@pixelsCtx</span>.canvas, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, ctx.canvas.width, ctx.canvas.height</pre></div></div>
            
        </li>
        
        
        <li id="section-41">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-41">&#182;</a>
              </div>
              <p>Diffuse the value of patch variable <code>p.v</code> by distributing <code>rate</code> percent
of each patch’s value of <code>v</code> to its neighbors. If a color <code>c</code> is given,
scale the patch’s color to be <code>p.v</code> of <code>c</code>. If the patch has
less than 8 neighbors, return the extra to the patch.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">diffuse</span>: <span class="hljs-function"><span class="hljs-params">(v, rate, c)</span> -&gt;</span> <span class="hljs-comment"># variable name, diffusion rate, max color (optional)</span></pre></div></div>
            
        </li>
        
        
        <li id="section-42">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-42">&#182;</a>
              </div>
              <p>zero temp variable if not yet set</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> @[<span class="hljs-number">0</span>]._diffuseNext?
      p._diffuseNext = <span class="hljs-number">0</span> <span class="hljs-keyword">for</span> p <span class="hljs-keyword">in</span> @</pre></div></div>
            
        </li>
        
        
        <li id="section-43">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-43">&#182;</a>
              </div>
              <p>pass 1: calculate contribution of all patches to themselves and neighbors</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">for</span> p <span class="hljs-keyword">in</span> @
      dv = p[v]*rate; dv8 = dv/<span class="hljs-number">8</span>; nn = p.n.length
      p._diffuseNext += p[v] - dv + (<span class="hljs-number">8</span>-nn)*dv8
      n._diffuseNext += dv8 <span class="hljs-keyword">for</span> n <span class="hljs-keyword">in</span> p.n</pre></div></div>
            
        </li>
        
        
        <li id="section-44">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-44">&#182;</a>
              </div>
              <p>pass 2: set new value for all patches, zero temp, modify color if c given</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">for</span> p <span class="hljs-keyword">in</span> @
      p[v] = p._diffuseNext
      p._diffuseNext = <span class="hljs-number">0</span>
      p.scaleColor c, p[v] <span class="hljs-keyword">if</span> c
    <span class="hljs-literal">null</span> <span class="hljs-comment"># avoid returning copy of @</span></pre></div></div>
            
        </li>
        
        
        <li id="section-45">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-45">&#182;</a>
              </div>
              <h3 id="agent-agents">Agent &amp; Agents</h3>

            </div>
            
        </li>
        
        
        <li id="section-46">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-46">&#182;</a>
              </div>
              <p>Class Agent instances represent the dynamic, behavioral element of ABM.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ABM</span>.<span class="hljs-title">Agent</span></span></pre></div></div>
            
        </li>
        
        
        <li id="section-47">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-47">&#182;</a>
              </div>
              <p>Constructor &amp; Class Variables:</p>
<ul>
<li>x,y: position on the patch grid, in patch coordinates, default: 0,0</li>
<li>color: the color of the agent, default: randomColor</li>
<li>shape: the shape name of the agent, default: “default”</li>
<li>heading: direction of the agent, in radians, from x-axis</li>
<li>hidden: whether or not to draw this agent</li>
<li>size: size of agent, in patch coords, default: 1</li>
<li>p: patch at current x,y location</li>
<li>penDown: true if agent pen is drawing</li>
<li>penSize: size in pixels of the pen, default: 1 pixel</li>
<li>breed: the agentset this agent belongs to</li>
<li>sprite: an image of the agent if non null</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">color</span>: <span class="hljs-literal">null</span>  <span class="hljs-comment"># default color, overrides random color if set</span>
  <span class="hljs-attribute">shape</span>: <span class="hljs-string">"default"</span>
  <span class="hljs-attribute">breed</span>: <span class="hljs-literal">null</span> <span class="hljs-comment"># set by the agentSet owning this agent</span>
  <span class="hljs-attribute">hidden</span>: <span class="hljs-literal">false</span>
  <span class="hljs-attribute">size</span>: <span class="hljs-number">1</span>
  <span class="hljs-attribute">penDown</span>: <span class="hljs-literal">false</span>
  <span class="hljs-attribute">penSize</span>: <span class="hljs-number">1</span> <span class="hljs-comment"># pixels</span>
  <span class="hljs-attribute">heading</span>: <span class="hljs-literal">null</span>
  <span class="hljs-attribute">sprite</span>: <span class="hljs-literal">null</span> <span class="hljs-comment"># default sprite, none</span>
  <span class="hljs-attribute">cacheLinks</span>: <span class="hljs-literal">false</span>
  <span class="hljs-attribute">constructor</span>:<span class="hljs-function"> -&gt;</span> <span class="hljs-comment"># called by agentSets create factory, not user</span>
    <span class="hljs-property">@x</span> = <span class="hljs-property">@y</span> = <span class="hljs-number">0</span>
    <span class="hljs-property">@color</span> = u.randomColor() <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-property">@color</span>? <span class="hljs-comment"># promote color if default not set</span>
    <span class="hljs-property">@heading</span> = u.randomFloat(Math.PI*<span class="hljs-number">2</span>) <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-property">@heading</span>?
    <span class="hljs-property">@p</span> = ABM.patches.patch <span class="hljs-property">@x</span>, <span class="hljs-property">@y</span>
    <span class="hljs-property">@p</span>.agents.push @ <span class="hljs-keyword">if</span> <span class="hljs-property">@p</span>.agents? <span class="hljs-comment"># ABM.patches.cacheAgentsHere</span>
    <span class="hljs-property">@links</span> = [] <span class="hljs-keyword">if</span> <span class="hljs-property">@cacheLinks</span></pre></div></div>
            
        </li>
        
        
        <li id="section-48">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-48">&#182;</a>
              </div>
              <p>Move agent to different breed agentSet.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">changeBreed</span>: <span class="hljs-function"><span class="hljs-params">(newBreed)</span> -&gt;</span>
    u.error <span class="hljs-string">"changeBreed: not in agentSet"</span> <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-property">@id</span>?
    u.error <span class="hljs-string">"changeBreed: breed illegally set"</span> <span class="hljs-keyword">if</span> <span class="hljs-property">@hasOwnProperty</span> <span class="hljs-string">"breed"</span>
    u.error <span class="hljs-string">"changeBreed: breed==newBreed"</span> <span class="hljs-keyword">if</span> <span class="hljs-property">@breed</span> <span class="hljs-keyword">is</span> newBreed
    <span class="hljs-property">@die</span><span class="hljs-function"><span class="hljs-params">()</span>; <span class="hljs-title">newBreed</span>.<span class="hljs-title">create</span> 1, <span class="hljs-params">(a)</span> =&gt;</span> a.setXY <span class="hljs-property">@x</span>, <span class="hljs-property">@y</span></pre></div></div>
            
        </li>
        
        
        <li id="section-49">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-49">&#182;</a>
              </div>
              <p>Set agent color to <code>c</code> scaled by <code>s</code>. Usage: see patch.scaleColor</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">scaleColor</span>: <span class="hljs-function"><span class="hljs-params">(c, s)</span> -&gt;</span>
    <span class="hljs-property">@color</span> = u.clone <span class="hljs-property">@color</span> <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-property">@hasOwnProperty</span> <span class="hljs-string">"color"</span> <span class="hljs-comment"># promote color to inst var</span>
    u.scaleColor c, s, <span class="hljs-property">@color</span></pre></div></div>
            
        </li>
        
        
        <li id="section-50">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-50">&#182;</a>
              </div>
              <p>Return a string representation of the agent.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">toString</span>:<span class="hljs-function"> -&gt;</span>
    <span class="hljs-string">"{id:<span class="hljs-subst">#{<span class="hljs-property">@id</span>}</span> xy:<span class="hljs-subst">#{u.aToFixed [<span class="hljs-property">@x</span>,<span class="hljs-property">@y</span>]}</span> c:<span class="hljs-subst">#{<span class="hljs-property">@color</span>}</span> h: <span class="hljs-subst">#{<span class="hljs-property">@heading</span>.toFixed <span class="hljs-number">2</span>}</span>}"</span></pre></div></div>
            
        </li>
        
        
        <li id="section-51">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-51">&#182;</a>
              </div>
              <p>Place the agent at the given x,y (floats) in patch coords
using patch topology (isTorus)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">setXY</span>: <span class="hljs-function"><span class="hljs-params">(x, y)</span> -&gt;</span> <span class="hljs-comment"># REMIND GC problem, 2 arrays</span>
    [x0, y0] = [<span class="hljs-property">@x</span>, <span class="hljs-property">@y</span>] <span class="hljs-keyword">if</span> <span class="hljs-property">@penDown</span>
    [<span class="hljs-property">@x</span>, <span class="hljs-property">@y</span>] = ABM.patches.coord x, y
    p = <span class="hljs-property">@p</span>
    <span class="hljs-property">@p</span> = ABM.patches.patch <span class="hljs-property">@x</span>, <span class="hljs-property">@y</span>
    <span class="hljs-keyword">if</span> p.agents? <span class="hljs-keyword">and</span> p <span class="hljs-keyword">isnt</span> <span class="hljs-property">@p</span> <span class="hljs-comment"># ABM.patches.cacheAgentsHere</span>
      u.removeItem p.agents, @
      <span class="hljs-property">@p</span>.agents.push @
    <span class="hljs-keyword">if</span> <span class="hljs-property">@penDown</span>
      drawing = ABM.drawing
      drawing.strokeStyle = u.colorStr <span class="hljs-property">@color</span>
      drawing.lineWidth = ABM.patches.fromBits <span class="hljs-property">@penSize</span>
      drawing.beginPath()
      drawing.moveTo x0, y0; drawing.lineTo x, y <span class="hljs-comment"># REMIND: euclidean</span>
      drawing.stroke()</pre></div></div>
            
        </li>
        
        
        <li id="section-52">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-52">&#182;</a>
              </div>
              <p>Place the agent at the given patch/agent location</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">moveTo</span>: <span class="hljs-function"><span class="hljs-params">(a)</span> -&gt;</span> <span class="hljs-property">@setXY</span> a.x, a.y</pre></div></div>
            
        </li>
        
        
        <li id="section-53">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-53">&#182;</a>
              </div>
              <p>Move forward (along heading) d units (patch coords),
using patch topology (isTorus)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">forward</span>: <span class="hljs-function"><span class="hljs-params">(d)</span> -&gt;</span>
    <span class="hljs-property">@setXY</span> <span class="hljs-property">@x</span> + d*Math.cos(<span class="hljs-property">@heading</span>), <span class="hljs-property">@y</span> + d*Math.sin(<span class="hljs-property">@heading</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-54">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-54">&#182;</a>
              </div>
              <p>Change current heading by rad radians which can be + (left) or - (right)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">rotate</span>: <span class="hljs-function"><span class="hljs-params">(rad)</span> -&gt;</span> <span class="hljs-property">@heading</span> = u.wrap <span class="hljs-property">@heading</span> + rad, <span class="hljs-number">0</span>, Math.PI*<span class="hljs-number">2</span> <span class="hljs-comment"># returns new h</span></pre></div></div>
            
        </li>
        
        
        <li id="section-55">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-55">&#182;</a>
              </div>
              <p>Draw the agent, instanciating a sprite if required</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">draw</span>: <span class="hljs-function"><span class="hljs-params">(ctx)</span> -&gt;</span>
    shape = ABM.shapes[<span class="hljs-property">@shape</span>]
    rad = <span class="hljs-keyword">if</span> shape.rotate <span class="hljs-keyword">then</span> <span class="hljs-property">@heading</span> <span class="hljs-keyword">else</span> <span class="hljs-number">0</span> <span class="hljs-comment"># radians</span>
    <span class="hljs-keyword">if</span> <span class="hljs-property">@sprite</span>? <span class="hljs-keyword">or</span> <span class="hljs-property">@breed</span>.useSprites
      <span class="hljs-property">@setSprite</span>() <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-property">@sprite</span>? <span class="hljs-comment"># lazy evaluation of useSprites</span>
      ABM.shapes.drawSprite ctx, <span class="hljs-property">@sprite</span>, <span class="hljs-property">@x</span>, <span class="hljs-property">@y</span>, <span class="hljs-property">@size</span>, rad
    <span class="hljs-keyword">else</span>
      ABM.shapes.draw ctx, shape, <span class="hljs-property">@x</span>, <span class="hljs-property">@y</span>, <span class="hljs-property">@size</span>, rad, <span class="hljs-property">@color</span></pre></div></div>
            
        </li>
        
        
        <li id="section-56">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-56">&#182;</a>
              </div>
              <p>Set an individual agent’s sprite, synching its color, shape, size</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">setSprite</span>: <span class="hljs-function"><span class="hljs-params">(sprite)</span>-&gt;</span>
    <span class="hljs-keyword">if</span> (s=sprite)?
      <span class="hljs-property">@sprite</span> = s; <span class="hljs-property">@color</span> = s.color; <span class="hljs-property">@shape</span> = s.shape; <span class="hljs-property">@size</span> = s.size
    <span class="hljs-keyword">else</span>
      <span class="hljs-property">@color</span> = u.randomColor <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-property">@color</span>?
      <span class="hljs-property">@sprite</span> = ABM.shapes.shapeToSprite <span class="hljs-property">@shape</span>, <span class="hljs-property">@color</span>, <span class="hljs-property">@size</span></pre></div></div>
            
        </li>
        
        
        <li id="section-57">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-57">&#182;</a>
              </div>
              <p>Draw the agent on the drawing layer, leaving permanent image.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">stamp</span>:<span class="hljs-function"> -&gt;</span> <span class="hljs-property">@draw</span> ABM.drawing</pre></div></div>
            
        </li>
        
        
        <li id="section-58">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-58">&#182;</a>
              </div>
              <p>Return distance in patch coords from me to x,y
using patch topology (isTorus)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">distanceXY</span>: <span class="hljs-function"><span class="hljs-params">(x,y)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> ABM.patches.isTorus
    <span class="hljs-keyword">then</span> u.torusDistance <span class="hljs-property">@x</span>, <span class="hljs-property">@y</span>, x, y, ABM.patches.numX, ABM.patches.numY
    <span class="hljs-keyword">else</span> u.distance <span class="hljs-property">@x</span>, <span class="hljs-property">@y</span>, x, y</pre></div></div>
            
        </li>
        
        
        <li id="section-59">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-59">&#182;</a>
              </div>
              <p>Return distance in patch coords from me to given agent/patch using patch topology.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">distance</span>: <span class="hljs-function"><span class="hljs-params">(o)</span> -&gt;</span> <span class="hljs-comment"># o any object w/ x,y, patch or agent</span>
    <span class="hljs-property">@distanceXY</span> o.x, o.y</pre></div></div>
            
        </li>
        
        
        <li id="section-60">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-60">&#182;</a>
              </div>
              <p>Return the closest torus topology point of given x,y relative to myself.
See util.torusPt.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">torusPtXY</span>: <span class="hljs-function"><span class="hljs-params">(x, y)</span> -&gt;</span>
    u.torusPt <span class="hljs-property">@x</span>, <span class="hljs-property">@y</span>, x, y, ABM.patches.numX, ABM.patches.numY</pre></div></div>
            
        </li>
        
        
        <li id="section-61">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-61">&#182;</a>
              </div>
              <p>Return the closest torus topology point of given agent/patch
relative to myself. See util.torusPt.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">torusPt</span>: <span class="hljs-function"><span class="hljs-params">(o)</span> -&gt;</span>
    <span class="hljs-property">@torusPtXY</span> o.x, o.y</pre></div></div>
            
        </li>
        
        
        <li id="section-62">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-62">&#182;</a>
              </div>
              <p>Set my heading towards given agent/patch using patch topology.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">face</span>: <span class="hljs-function"><span class="hljs-params">(o)</span> -&gt;</span> <span class="hljs-property">@heading</span> = <span class="hljs-property">@towards</span> o</pre></div></div>
            
        </li>
        
        
        <li id="section-63">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-63">&#182;</a>
              </div>
              <p>Return heading towards x,y using patch topology.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">towardsXY</span>: <span class="hljs-function"><span class="hljs-params">(x, y)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> ABM.patches.isTorus
    <span class="hljs-keyword">then</span> u.torusRadsToward <span class="hljs-property">@x</span>, <span class="hljs-property">@y</span>, x, y, ABM.patches.numX, ABM.patches.numY
    <span class="hljs-keyword">else</span> u.radsToward <span class="hljs-property">@x</span>, <span class="hljs-property">@y</span>, x, y</pre></div></div>
            
        </li>
        
        
        <li id="section-64">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-64">&#182;</a>
              </div>
              <p>Return heading towards given agent/patch using patch topology.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">towards</span>: <span class="hljs-function"><span class="hljs-params">(o)</span> -&gt;</span> <span class="hljs-property">@towardsXY</span> o.x, o.y</pre></div></div>
            
        </li>
        
        
        <li id="section-65">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-65">&#182;</a>
              </div>
              <p>Remove myself from the model.  Includes removing myself from the agents
agentset and removing any links I may have.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">die</span>:<span class="hljs-function"> -&gt;</span>
    <span class="hljs-property">@breed</span>.remove @
    l.die() <span class="hljs-keyword">for</span> l <span class="hljs-keyword">in</span> <span class="hljs-property">@myLinks</span>()
    u.removeItem <span class="hljs-property">@p</span>.agents, @ <span class="hljs-keyword">if</span> <span class="hljs-property">@p</span>.agents?
    <span class="hljs-literal">null</span></pre></div></div>
            
        </li>
        
        
        <li id="section-66">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-66">&#182;</a>
              </div>
              <p>Factory: create num new agents at this agents location. The optional init
proc is called on the new agent after inserting in its agentSet.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">hatch</span>: <span class="hljs-function"><span class="hljs-params">(num = <span class="hljs-number">1</span>, breed = ABM.agents, init = -&gt;)</span> -&gt;</span>
    breed.create num, <span class="hljs-function"><span class="hljs-params">(a)</span> =&gt;</span> <span class="hljs-comment"># fat arrow so that @ = this agent</span>
      a.setXY <span class="hljs-property">@x</span>, <span class="hljs-property">@y</span> <span class="hljs-comment"># for side effects like patches.agentsHere</span>
      a[k] = v <span class="hljs-keyword">for</span> own k, v <span class="hljs-keyword">of</span> @ <span class="hljs-keyword">when</span> k <span class="hljs-keyword">isnt</span> <span class="hljs-string">"id"</span>
      init(a); a <span class="hljs-comment"># Important: init called after object inserted in agent set</span></pre></div></div>
            
        </li>
        
        
        <li id="section-67">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-67">&#182;</a>
              </div>
              <p>Return the members of the given agentset that are within radius distance
from me, and within cone radians of my heading using patch topology</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">inCone</span>: <span class="hljs-function"><span class="hljs-params">(aset, cone, radius, meToo=<span class="hljs-literal">false</span>)</span> -&gt;</span>
    aset.inCone <span class="hljs-property">@p</span>, <span class="hljs-property">@heading</span>, cone, radius, meToo <span class="hljs-comment"># REMIND: @p vs @?</span></pre></div></div>
            
        </li>
        
        
        <li id="section-68">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-68">&#182;</a>
              </div>
              <p>Return other end of link from me</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">otherEnd</span>: <span class="hljs-function"><span class="hljs-params">(l)</span> -&gt;</span> <span class="hljs-keyword">if</span> l.end1 <span class="hljs-keyword">is</span> @ <span class="hljs-keyword">then</span> l.end2 <span class="hljs-keyword">else</span> l.end1</pre></div></div>
            
        </li>
        
        
        <li id="section-69">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-69">&#182;</a>
              </div>
              <p>Return all links linked to me</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">myLinks</span>:<span class="hljs-function"> -&gt;</span>
    <span class="hljs-property">@links</span> ? (l <span class="hljs-keyword">for</span> l <span class="hljs-keyword">in</span> ABM.links <span class="hljs-keyword">when</span> (l.end1 <span class="hljs-keyword">is</span> @) <span class="hljs-keyword">or</span> (l.end2 <span class="hljs-keyword">is</span> @))</pre></div></div>
            
        </li>
        
        
        <li id="section-70">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-70">&#182;</a>
              </div>
              <p>Return all agents linked to me.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">linkNeighbors</span>:<span class="hljs-function"> -&gt;</span> <span class="hljs-comment"># return all agents linked to me</span>
    <span class="hljs-property">@otherEnd</span> l <span class="hljs-keyword">for</span> l <span class="hljs-keyword">in</span> <span class="hljs-property">@myLinks</span>()</pre></div></div>
            
        </li>
        
        
        <li id="section-71">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-71">&#182;</a>
              </div>
              <p>Return links where I am the “to” agent in links.create</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">myInLinks</span>:<span class="hljs-function"> -&gt;</span>
    l <span class="hljs-keyword">for</span> l <span class="hljs-keyword">in</span> <span class="hljs-property">@myLinks</span>() <span class="hljs-keyword">when</span> l.end2 <span class="hljs-keyword">is</span> @</pre></div></div>
            
        </li>
        
        
        <li id="section-72">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-72">&#182;</a>
              </div>
              <p>Return other end of myInLinks</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">inLinkNeighbors</span>:<span class="hljs-function"> -&gt;</span>
    l.end1 <span class="hljs-keyword">for</span> l <span class="hljs-keyword">in</span> <span class="hljs-property">@myLinks</span>() <span class="hljs-keyword">when</span> l.end2 <span class="hljs-keyword">is</span> @</pre></div></div>
            
        </li>
        
        
        <li id="section-73">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-73">&#182;</a>
              </div>
              <p>Return links where I am the “from” agent in links.create</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">myOutLinks</span>:<span class="hljs-function"> -&gt;</span>
    l <span class="hljs-keyword">for</span> l <span class="hljs-keyword">in</span> <span class="hljs-property">@myLinks</span>() <span class="hljs-keyword">when</span> l.end1 <span class="hljs-keyword">is</span> @</pre></div></div>
            
        </li>
        
        
        <li id="section-74">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-74">&#182;</a>
              </div>
              <p>Return other end of myOutinks</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">outLinkNeighbors</span>:<span class="hljs-function"> -&gt;</span>
    l.end2 <span class="hljs-keyword">for</span> l <span class="hljs-keyword">in</span> <span class="hljs-property">@myLinks</span>() <span class="hljs-keyword">when</span> l.end1 <span class="hljs-keyword">is</span> @</pre></div></div>
            
        </li>
        
        
        <li id="section-75">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-75">&#182;</a>
              </div>
              <p>Class Agents is a subclass of AgentSet which stores instances of Agent or
Breeds, which are subclasses of Agent</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ABM</span>.<span class="hljs-title">Agents</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">ABM</span>.<span class="hljs-title">AgentSet</span></span></pre></div></div>
            
        </li>
        
        
        <li id="section-76">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-76">&#182;</a>
              </div>
              <p>Constructor creates the empty AgentSet instance and installs
the agentClass (breed) variable shared by all the Agents in this set.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">constructor</span>:<span class="hljs-function"> -&gt;</span> <span class="hljs-comment"># agentClass, name, mainSet</span>
    <span class="hljs-keyword">super</span> <span class="hljs-comment"># call super with all the args I was called with</span>
    <span class="hljs-property">@useSprites</span> = <span class="hljs-literal">false</span></pre></div></div>
            
        </li>
        
        
        <li id="section-77">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-77">&#182;</a>
              </div>
              <p>Have agents cache the links with them as a node.
Optimizes Agent a.myLinks method. Call before any agents created.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">cacheLinks</span>:<span class="hljs-function"> -&gt;</span> ABM.<span class="hljs-attribute">Agent</span>::cacheLinks = <span class="hljs-literal">true</span> <span class="hljs-comment"># all agents, not individual breeds</span></pre></div></div>
            
        </li>
        
        
        <li id="section-78">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-78">&#182;</a>
              </div>
              <p>Methods to change the default Agent class variables.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">setDefaultColor</span>:  <span class="hljs-function"><span class="hljs-params">(color)</span> -&gt;</span> <span class="hljs-property">@agentClass</span>::color = color
  <span class="hljs-attribute">setDefaultShape</span>:  <span class="hljs-function"><span class="hljs-params">(shape)</span> -&gt;</span> <span class="hljs-property">@agentClass</span>::shape = shape
  <span class="hljs-attribute">setDefaultSize</span>:   <span class="hljs-function"><span class="hljs-params">(size)</span>  -&gt;</span> <span class="hljs-property">@agentClass</span>::size = size
  <span class="hljs-attribute">setDefaultHeading</span>:<span class="hljs-function"><span class="hljs-params">(heading)</span>-&gt;</span> <span class="hljs-property">@agentClass</span>::heading = heading
  <span class="hljs-attribute">setDefaultHidden</span>: <span class="hljs-function"><span class="hljs-params">(hidden)</span>-&gt;</span> <span class="hljs-property">@agentClass</span>::hidden = hidden
  <span class="hljs-attribute">setDefaultSprite</span>: <span class="hljs-function"><span class="hljs-params">(sprite)</span>-&gt;</span>
    <span class="hljs-property">@setDefaultColor</span> sprite.color; <span class="hljs-property">@setDefaultShape</span> sprite.shape; <span class="hljs-property">@setDefaultSize</span> sprite.size
    <span class="hljs-property">@agentClass</span>::sprite = sprite
  <span class="hljs-attribute">setDefaultPen</span>:   <span class="hljs-function"><span class="hljs-params">(size, down=<span class="hljs-literal">false</span>)</span> -&gt;</span>
    <span class="hljs-property">@agentClass</span>::penSize = size
    <span class="hljs-property">@agentClass</span>::penDown = down</pre></div></div>
            
        </li>
        
        
        <li id="section-79">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-79">&#182;</a>
              </div>
              <p>Use sprites rather than drawing</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">setUseSprites</span>: <span class="hljs-function"><span class="hljs-params">(<span class="hljs-property">@useSprites</span>=<span class="hljs-literal">true</span>)</span> -&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-80">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-80">&#182;</a>
              </div>
              <p>Filter to return all instances of this breed.  Note: if used by
the mainSet, returns just the agents that are not subclassed breeds.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">in</span>: <span class="hljs-function"><span class="hljs-params">(array)</span> -&gt;</span> <span class="hljs-property">@asSet</span> (o <span class="hljs-keyword">for</span> o <span class="hljs-keyword">in</span> array <span class="hljs-keyword">when</span> o.breed <span class="hljs-keyword">is</span> @)</pre></div></div>
            
        </li>
        
        
        <li id="section-81">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-81">&#182;</a>
              </div>
              <p>Factory: create num new agents stored in this agentset.The optional init
proc is called on the new agent after inserting in its agentSet.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">create</span>: <span class="hljs-function"><span class="hljs-params">(num, init = -&gt;)</span> -&gt;</span> <span class="hljs-comment"># returns list too</span>
    <span class="hljs-function"><span class="hljs-params">((o) -&gt; init(o); o)</span> @<span class="hljs-title">add</span> <span class="hljs-title">new</span> @<span class="hljs-title">agentClass</span> <span class="hljs-title">for</span> <span class="hljs-title">i</span> <span class="hljs-title">in</span> [1..<span class="hljs-title">num</span>] <span class="hljs-title">by</span> 1 # <span class="hljs-title">too</span> <span class="hljs-title">tricky</span>?

</span></pre></div></div>
            
        </li>
        
        
        <li id="section-82">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-82">&#182;</a>
              </div>
              <p>Remove all agents from set via agent.die()
Note call in reverse order to optimize list restructuring.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">clear</span>:<span class="hljs-function"> -&gt;</span> <span class="hljs-property">@last</span>().die() <span class="hljs-keyword">while</span> <span class="hljs-property">@any</span>(); <span class="hljs-literal">null</span> <span class="hljs-comment"># tricky, each die modifies list</span></pre></div></div>
            
        </li>
        
        
        <li id="section-83">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-83">&#182;</a>
              </div>
              <p>Return an agentset of agents within the patch array</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">inPatches</span>: <span class="hljs-function"><span class="hljs-params">(patches)</span> -&gt;</span>
    array = []
    array.push p.agentsHere()... <span class="hljs-keyword">for</span> p <span class="hljs-keyword">in</span> patches <span class="hljs-comment"># concat measured slower</span>
    <span class="hljs-keyword">if</span> <span class="hljs-property">@mainSet</span>? <span class="hljs-keyword">then</span> <span class="hljs-property">@in</span> array <span class="hljs-keyword">else</span> <span class="hljs-property">@asSet</span> array</pre></div></div>
            
        </li>
        
        
        <li id="section-84">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-84">&#182;</a>
              </div>
              <p>Return an agentset of agents within the patchRect</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">inRect</span>: <span class="hljs-function"><span class="hljs-params">(a, dx, dy, meToo=<span class="hljs-literal">false</span>)</span> -&gt;</span>
    rect = ABM.patches.patchRect a.p, dx, dy, <span class="hljs-literal">true</span>
    rect = <span class="hljs-property">@inPatches</span> rect
    u.removeItem rect, a <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> meToo
    rect</pre></div></div>
            
        </li>
        
        
        <li id="section-85">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-85">&#182;</a>
              </div>
              <p>Return the members of this agentset that are within radius distance
from me, and within cone radians of my heading using patch topology</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">inCone</span>: <span class="hljs-function"><span class="hljs-params">(a, heading, cone, radius, meToo=<span class="hljs-literal">false</span>)</span> -&gt;</span> <span class="hljs-comment"># heading? .. so p ok?</span>
    as = <span class="hljs-property">@inRect</span> a, radius, radius, <span class="hljs-literal">true</span>
    as.inCone a, heading, cone, radius, meToo</pre></div></div>
            
        </li>
        
        
        <li id="section-86">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-86">&#182;</a>
              </div>
              <p>Return the members of this agentset that are within radius distance
from me, using patch topology</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">inRadius</span>: <span class="hljs-function"><span class="hljs-params">(a, radius, meToo=<span class="hljs-literal">false</span>)</span>-&gt;</span>
    as = <span class="hljs-property">@inRect</span> a, radius, radius, <span class="hljs-literal">true</span>
    as.inRadius a, radius, meToo</pre></div></div>
            
        </li>
        
        
        <li id="section-87">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-87">&#182;</a>
              </div>
              <h3 id="link-and-links">Link and Links</h3>

            </div>
            
        </li>
        
        
        <li id="section-88">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-88">&#182;</a>
              </div>
              <p>Class Link connects two agent endpoints for graph modeling.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ABM</span>.<span class="hljs-title">Link</span></span></pre></div></div>
            
        </li>
        
        
        <li id="section-89">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-89">&#182;</a>
              </div>
              <p>Constructor initializes instance variables:</p>
<ul>
<li>breed: the agentset this link belongs to</li>
<li>end1, end2: two agents being connected</li>
<li>color: defaults to light gray</li>
<li>thickness: thickness in pixels of the link, default 2</li>
<li>hidden: whether or not to draw this link</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">breed</span>: <span class="hljs-literal">null</span> <span class="hljs-comment"># set by the agentSet owning this link</span>
  <span class="hljs-attribute">color</span>: [<span class="hljs-number">130</span>, <span class="hljs-number">130</span>, <span class="hljs-number">130</span>]
  <span class="hljs-attribute">thickness</span>: <span class="hljs-number">2</span>
  <span class="hljs-attribute">hidden</span>: <span class="hljs-literal">false</span>
  <span class="hljs-attribute">constructor</span>: <span class="hljs-function"><span class="hljs-params">(<span class="hljs-property">@end1</span>, <span class="hljs-property">@end2</span>)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> <span class="hljs-property">@end1</span>.links?
      <span class="hljs-property">@end1</span>.links.push @
      <span class="hljs-property">@end2</span>.links.push @</pre></div></div>
            
        </li>
        
        
        <li id="section-90">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-90">&#182;</a>
              </div>
              <p>Draw a line between the two endpoints.  Draws “around” the
torus if appropriate using two lines. As with Agent.draw,
is called with patch coordinate transform installed.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">draw</span>: <span class="hljs-function"><span class="hljs-params">(ctx)</span> -&gt;</span>
    ctx.save()
    ctx.strokeStyle = u.colorStr <span class="hljs-property">@color</span>
    ctx.lineWidth = ABM.patches.fromBits <span class="hljs-property">@thickness</span>
    ctx.beginPath()
    <span class="hljs-keyword">if</span> !ABM.patches.isTorus
      ctx.moveTo <span class="hljs-property">@end1</span>.x, <span class="hljs-property">@end1</span>.y
      ctx.lineTo <span class="hljs-property">@end2</span>.x, <span class="hljs-property">@end2</span>.y
    <span class="hljs-keyword">else</span>
      pt = <span class="hljs-property">@end1</span>.torusPt <span class="hljs-property">@end2</span>
      ctx.moveTo <span class="hljs-property">@end1</span>.x, <span class="hljs-property">@end1</span>.y
      ctx.lineTo pt...
      <span class="hljs-keyword">if</span> pt[<span class="hljs-number">0</span>] <span class="hljs-keyword">isnt</span> <span class="hljs-property">@end2</span>.x <span class="hljs-keyword">or</span> pt[<span class="hljs-number">1</span>] <span class="hljs-keyword">isnt</span> <span class="hljs-property">@end2</span>.y
        pt = <span class="hljs-property">@end2</span>.torusPt <span class="hljs-property">@end1</span>
        ctx.moveTo <span class="hljs-property">@end2</span>.x, <span class="hljs-property">@end2</span>.y
        ctx.lineTo pt...
    ctx.closePath()
    ctx.stroke()
    ctx.restore()</pre></div></div>
            
        </li>
        
        
        <li id="section-91">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-91">&#182;</a>
              </div>
              <p>Remove this link from the agent set</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">die</span>:<span class="hljs-function"> -&gt;</span>
    <span class="hljs-property">@breed</span>.remove @
    u.removeItem <span class="hljs-property">@end1</span>.links, @ <span class="hljs-keyword">if</span> <span class="hljs-property">@end1</span>.links?
    u.removeItem <span class="hljs-property">@end2</span>.links, @ <span class="hljs-keyword">if</span> <span class="hljs-property">@end2</span>.links?
    <span class="hljs-literal">null</span></pre></div></div>
            
        </li>
        
        
        <li id="section-92">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-92">&#182;</a>
              </div>
              <p>Return the two endpoints of this link</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">bothEnds</span>:<span class="hljs-function"> -&gt;</span> [<span class="hljs-property">@end1</span>, <span class="hljs-property">@end2</span>]</pre></div></div>
            
        </li>
        
        
        <li id="section-93">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-93">&#182;</a>
              </div>
              <p>Return the distance between the endpoints with the current topology.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">length</span>:<span class="hljs-function"> -&gt;</span> <span class="hljs-property">@end1</span>.distance <span class="hljs-property">@end2</span></pre></div></div>
            
        </li>
        
        
        <li id="section-94">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-94">&#182;</a>
              </div>
              <p>Return the other end of the link, given an endpoint agent.
Assumes the given input <em>is</em> one of the link endpoint pairs!</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">otherEnd</span>: <span class="hljs-function"><span class="hljs-params">(a)</span> -&gt;</span> <span class="hljs-keyword">if</span> <span class="hljs-property">@end1</span> <span class="hljs-keyword">is</span> a <span class="hljs-keyword">then</span> <span class="hljs-property">@end2</span> <span class="hljs-keyword">else</span> <span class="hljs-property">@end1</span></pre></div></div>
            
        </li>
        
        
        <li id="section-95">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-95">&#182;</a>
              </div>
              <p>Class Links is a subclass of AgentSet which stores instances of Link
or subclasses of Link</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ABM</span>.<span class="hljs-title">Links</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">ABM</span>.<span class="hljs-title">AgentSet</span></span></pre></div></div>
            
        </li>
        
        
        <li id="section-96">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-96">&#182;</a>
              </div>
              <p>Constructor: super creates the empty AgentSet instance and installs
the agentClass (breed) variable shared by all the Links in this set.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">constructor</span>:<span class="hljs-function"> -&gt;</span> <span class="hljs-comment"># agentClass, name, mainSet</span>
    <span class="hljs-keyword">super</span> <span class="hljs-comment"># call super with all the args I was called with</span></pre></div></div>
            
        </li>
        
        
        <li id="section-97">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-97">&#182;</a>
              </div>
              <p>Methods to change the default Link class variables.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">setDefaultColor</span>:     <span class="hljs-function"><span class="hljs-params">(color)</span>      -&gt;</span> <span class="hljs-property">@agentClass</span>::color = color
  <span class="hljs-attribute">setDefaultThickness</span>: <span class="hljs-function"><span class="hljs-params">(thickness)</span>  -&gt;</span> <span class="hljs-property">@agentClass</span>::thickness = thickness
  <span class="hljs-attribute">setDefaultHidden</span>:    <span class="hljs-function"><span class="hljs-params">(hidden)</span>     -&gt;</span> <span class="hljs-property">@agentClass</span>::hidden = hidden</pre></div></div>
            
        </li>
        
        
        <li id="section-98">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-98">&#182;</a>
              </div>
              <p>Factory: Add 1 or more links from the from agent to the to agent(s) which
can be a single agent or an array of agents. The optional init
proc is called on the new link after inserting in the agentSet.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">create</span>: <span class="hljs-function"><span class="hljs-params">(from, to, init = -&gt;)</span> -&gt;</span> <span class="hljs-comment"># returns list too</span>
    to = [to] <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> to.length?
    <span class="hljs-function"><span class="hljs-params">((o) -&gt; init(o); o)</span> @<span class="hljs-title">add</span> <span class="hljs-title">new</span> @<span class="hljs-title">agentClass</span> <span class="hljs-title">from</span>, <span class="hljs-title">a</span> <span class="hljs-title">for</span> <span class="hljs-title">a</span> <span class="hljs-title">in</span> <span class="hljs-title">to</span> # <span class="hljs-title">too</span> <span class="hljs-title">tricky</span>?

</span></pre></div></div>
            
        </li>
        
        
        <li id="section-99">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-99">&#182;</a>
              </div>
              <p>Remove all links from set via link.die()
Note call in reverse order to optimize list restructuring.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">clear</span>:<span class="hljs-function"> -&gt;</span> <span class="hljs-property">@last</span>().die() <span class="hljs-keyword">while</span> <span class="hljs-property">@any</span>(); <span class="hljs-literal">null</span> <span class="hljs-comment"># tricky, each die modifies list</span></pre></div></div>
            
        </li>
        
        
        <li id="section-100">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-100">&#182;</a>
              </div>
              <p>Return the subset of this set with the given breed value.
breed: (breed) -&gt; @getPropWith “breed”, breed</p>

            </div>
            
        </li>
        
        
        <li id="section-101">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-101">&#182;</a>
              </div>
              <p>Return all the nodes in this agentset, with duplicates
included.  If 4 links have the same endpoint, it will
appear 4 times.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">allEnds</span>:<span class="hljs-function"> -&gt;</span> <span class="hljs-comment"># all link ends, w/ dups</span>
    n = <span class="hljs-property">@asSet</span> []
    n.push l.end1, l.end2 <span class="hljs-keyword">for</span> l <span class="hljs-keyword">in</span> @
    n</pre></div></div>
            
        </li>
        
        
        <li id="section-102">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-102">&#182;</a>
              </div>
              <p>Returns all the nodes in this agentset sorted by ID and with
duplicates removed.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">nodes</span>:<span class="hljs-function"> -&gt;</span> <span class="hljs-comment"># allEnds without dups</span>
    <span class="hljs-property">@allEnds</span>().sortById().uniq()</pre></div></div>
            
        </li>
        
        
        <li id="section-103">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-103">&#182;</a>
              </div>
              <p>Circle Layout: position the agents in the list in an equally
spaced circle of the given radius, with the initial agent
at the given start angle (default to pi/2 or “up”) and in the
+1 or -1 direction (counder clockwise or clockwise)
defaulting to -1 (clockwise).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">layoutCircle</span>: <span class="hljs-function"><span class="hljs-params">(list, radius, startAngle = Math.PI/<span class="hljs-number">2</span>, direction = -<span class="hljs-number">1</span>)</span> -&gt;</span>
    dTheta = <span class="hljs-number">2</span>*Math.PI/list.length
    <span class="hljs-keyword">for</span> a, i <span class="hljs-keyword">in</span> list
      a.setXY <span class="hljs-number">0</span>, <span class="hljs-number">0</span>
      a.heading = startAngle + direction*dTheta*i
      a.forward radius
    <span class="hljs-literal">null</span></pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
