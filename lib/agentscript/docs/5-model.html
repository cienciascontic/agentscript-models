<!DOCTYPE html>

<html>
<head>
  <title>5-model.coffee</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="1-util.html">
                1-util.coffee
              </a>
            
              
              <a class="source" href="2-shapes.html">
                2-shapes.coffee
              </a>
            
              
              <a class="source" href="3-agentset.html">
                3-agentset.coffee
              </a>
            
              
              <a class="source" href="4-agentsets.html">
                4-agentsets.coffee
              </a>
            
              
              <a class="source" href="5-model.html">
                5-model.coffee
              </a>
            
              
              <a class="source" href="6-template.html">
                6-template.coffee
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>5-model.coffee</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <p>Class Model is the control center for our AgentSets: Patches, Agents and Links.
Creating new models is done by subclassing class Model and overriding two 
virtual/abstract methods: <code>setup()</code> and <code>step()</code></p>

            </div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <h3 id="animator">Animator</h3>

            </div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>Because not all models have the same amimator requirements, we build a class
for customization by the programmer.  See these URLs for more info:</p>
<ul>
<li><a href="https://developer.mozilla.org/en-US/docs/JavaScript/Timers">JavaScript timers doc</a></li>
<li><a href="http://goo.gl/ymEEX">Using timers &amp; requestAnimFrame together</a></li>
<li><a href="http://goo.gl/9Q3q">John Resig on timers</a></li>
<li><a href="http://jsfiddle.net/calpo/H7EEE/">jsFiddle setTimeout vs rAF</a></li>
<li><a href="http://javascript.info/tutorial/settimeout-setinterval">Timeout tutorial</a></li>
<li><a href="http://javascript.info/tutorial/events-and-timing-depth">Events and timing in depth</a></li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>  
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ABM</span>.<span class="hljs-title">Animator</span></span></pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>Create initial animator for the model, specifying default rate (fps) and multiStep (async).
If multiStep, run the draw() and step() methods asynchronously by draw() using
requestAnimFrame and step() using setTimeout.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">constructor</span>: <span class="hljs-function"><span class="hljs-params">(<span class="hljs-property">@model</span>, <span class="hljs-property">@rate</span>=<span class="hljs-number">30</span>, <span class="hljs-property">@multiStep</span>=<span class="hljs-literal">false</span>, <span class="hljs-property">@drawRate</span>=<span class="hljs-number">30</span>)</span> -&gt;</span> <span class="hljs-property">@reset</span>() <span class="hljs-comment"># init all animation state</span></pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>Adjust animator.  This is used by programmer as the default animator will already have
been created by the time her model runs.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">setRate</span>: <span class="hljs-function"><span class="hljs-params">(rate, <span class="hljs-property">@multiStep</span>=<span class="hljs-literal">false</span>)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> <span class="hljs-property">@drawRate</span> <span class="hljs-keyword">is</span> <span class="hljs-property">@rate</span>
      <span class="hljs-property">@drawRate</span> = rate
    <span class="hljs-property">@rate</span> = rate
    <span class="hljs-property">@resetAnim</span>()
  <span class="hljs-attribute">setDrawRate</span>: <span class="hljs-function"><span class="hljs-params">(<span class="hljs-property">@drawRate</span>)</span> -&gt;</span> <span class="hljs-property">@resetAnim</span>()</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>start/stop model, often used for debugging</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">start</span>:<span class="hljs-function"> -&gt;</span>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-property">@animStop</span> <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> <span class="hljs-comment"># avoid multiple animates</span>
    <span class="hljs-property">@resetAnim</span>()
    <span class="hljs-property">@animStop</span> = <span class="hljs-literal">false</span>
    <span class="hljs-property">@animate</span>()
  <span class="hljs-attribute">resetAnim</span>:<span class="hljs-function"> -&gt;</span>
    <span class="hljs-property">@startMS</span> = <span class="hljs-property">@now</span>()
    <span class="hljs-property">@startTick</span> = <span class="hljs-property">@ticks</span>
    <span class="hljs-property">@startDraw</span> = <span class="hljs-property">@draws</span>
  <span class="hljs-attribute">stop</span>:<span class="hljs-function"> -&gt;</span>
    <span class="hljs-property">@animStop</span> = <span class="hljs-literal">true</span>
    <span class="hljs-keyword">if</span> <span class="hljs-property">@animHandle</span>? <span class="hljs-keyword">then</span> cancelAnimFrame <span class="hljs-property">@animHandle</span>
    <span class="hljs-keyword">if</span> <span class="hljs-property">@timeoutHandle</span>? <span class="hljs-keyword">then</span> clearTimeout <span class="hljs-property">@timeoutHandle</span>
    <span class="hljs-keyword">if</span> <span class="hljs-property">@intervalHandle</span>? <span class="hljs-keyword">then</span> clearInterval <span class="hljs-property">@intervalHandle</span>
    <span class="hljs-property">@animHandle</span> = <span class="hljs-property">@timerHandle</span> = <span class="hljs-property">@intervalHandle</span> = <span class="hljs-literal">null</span>
  <span class="hljs-attribute">reset</span>:<span class="hljs-function"> -&gt;</span> <span class="hljs-property">@stop</span>(); <span class="hljs-property">@ticks</span> = <span class="hljs-property">@draws</span> = <span class="hljs-number">0</span></pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>step/draw the model.  Note ticks/draws counters separate due to async.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">step</span>:<span class="hljs-function"> -&gt;</span> <span class="hljs-property">@ticks</span>++; <span class="hljs-property">@model</span>.step()
  <span class="hljs-attribute">drawInProgress</span>: <span class="hljs-literal">false</span>
  <span class="hljs-attribute">draw</span>:<span class="hljs-function"> -&gt;</span>
    <span class="hljs-keyword">unless</span> <span class="hljs-property">@drawInProgress</span>
      <span class="hljs-property">@drawInProgress</span> = <span class="hljs-literal">true</span>
      setTimeout<span class="hljs-function"> =&gt;</span>
        <span class="hljs-property">@draws</span>++;
        <span class="hljs-property">@model</span>.draw()
        <span class="hljs-property">@drawInProgress</span> = <span class="hljs-literal">false</span>
      , <span class="hljs-number">1</span>
      <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span></pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>step and draw the model once, mainly debugging</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">once</span>:<span class="hljs-function"> -&gt;</span> <span class="hljs-property">@step</span>(); <span class="hljs-property">@draw</span>()</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>Get current time, with high resolution timer if available</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">now</span>:<span class="hljs-function"> -&gt;</span>
    <span class="hljs-keyword">if</span> performance?.now?
      performance.now()
    <span class="hljs-keyword">else</span>
      Date.now()</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>Time in ms since starting animator</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">ms</span>:<span class="hljs-function"> -&gt;</span> <span class="hljs-property">@now</span>()-<span class="hljs-property">@startMS</span></pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>Get the number of ticks/draws per second.  They will differ if async</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">ticksPerSec</span>:<span class="hljs-function"> -&gt;</span> <span class="hljs-keyword">if</span> (elapsed = <span class="hljs-property">@ticks</span>-<span class="hljs-property">@startTick</span>) <span class="hljs-keyword">is</span> <span class="hljs-number">0</span> <span class="hljs-keyword">then</span> <span class="hljs-number">0</span> <span class="hljs-keyword">else</span> Math.round elapsed*<span class="hljs-number">1000</span>/<span class="hljs-property">@ms</span>()
  <span class="hljs-attribute">drawsPerSec</span>:<span class="hljs-function"> -&gt;</span> <span class="hljs-keyword">if</span> (elapsed = <span class="hljs-property">@draws</span>-<span class="hljs-property">@startDraw</span>) <span class="hljs-keyword">is</span> <span class="hljs-number">0</span> <span class="hljs-keyword">then</span> <span class="hljs-number">0</span> <span class="hljs-keyword">else</span> Math.round elapsed*<span class="hljs-number">1000</span>/<span class="hljs-property">@ms</span>()</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>Return a status string for debugging and logging performance</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">toString</span>:<span class="hljs-function"> -&gt;</span> <span class="hljs-string">"ticks: <span class="hljs-subst">#{<span class="hljs-property">@ticks</span>}</span>, draws: <span class="hljs-subst">#{<span class="hljs-property">@draws</span>}</span>, rate: <span class="hljs-subst">#{<span class="hljs-property">@rate</span>}</span>/<span class="hljs-subst">#{<span class="hljs-property">@drawRate</span>}</span> <span class="hljs-subst">#{<span class="hljs-property">@ticksPerSec</span>()}</span>/<span class="hljs-subst">#{<span class="hljs-property">@drawsPerSec</span>()}</span>"</span></pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>Animation via setTimeout and requestAnimFrame</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">animateSteps</span>:<span class="hljs-function"> =&gt;</span>
    <span class="hljs-property">@step</span>()
    <span class="hljs-property">@timeoutHandle</span> = setTimeout <span class="hljs-property">@animateSteps</span>, (<span class="hljs-number">1000.0</span>/<span class="hljs-property">@rate</span>) <span class="hljs-keyword">unless</span> <span class="hljs-property">@animStop</span>
  <span class="hljs-attribute">animateDraws</span>:<span class="hljs-function"> =&gt;</span>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-property">@multiStep</span> <span class="hljs-keyword">and</span> <span class="hljs-property">@ticksPerSec</span>() &lt;= <span class="hljs-property">@rate</span>
      <span class="hljs-property">@step</span>()
    <span class="hljs-keyword">if</span> <span class="hljs-property">@drawsPerSec</span>() &lt;= <span class="hljs-property">@drawRate</span>
      <span class="hljs-property">@draw</span>()
    <span class="hljs-property">@animHandle</span> = requestAnimFrame <span class="hljs-property">@animateDraws</span> <span class="hljs-keyword">unless</span> <span class="hljs-property">@animStop</span>
  <span class="hljs-attribute">animate</span>:<span class="hljs-function"> -&gt;</span>
    <span class="hljs-keyword">if</span> <span class="hljs-property">@multiStep</span>
      <span class="hljs-property">@animateSteps</span>()
    <span class="hljs-property">@animateDraws</span>()</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <h3 id="class-model">Class Model</h3>

            </div>
            
            <div class="content"><div class='highlight'><pre>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ABM</span>.<span class="hljs-title">Model</span>  </span></pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>Class variable for layers parameters. 
Can be added to by programmer to modify/create layers, <strong>before</strong> starting your own model.
Example:</p>
<pre><code>v.z++ <span class="hljs-keyword">for</span> k,v <span class="hljs-keyword">of</span> ABM.<span class="hljs-attribute">Model</span>::contextsInit <span class="hljs-comment"># increase each z value by one</span>
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">contextsInit</span>: {
    <span class="hljs-attribute">patches</span>:   {<span class="hljs-attribute">z</span>:<span class="hljs-number">0</span>, <span class="hljs-attribute">ctx</span>:<span class="hljs-string">"2d"</span>}
    <span class="hljs-attribute">drawing</span>:   {<span class="hljs-attribute">z</span>:<span class="hljs-number">1</span>, <span class="hljs-attribute">ctx</span>:<span class="hljs-string">"2d"</span>}
    <span class="hljs-attribute">links</span>:     {<span class="hljs-attribute">z</span>:<span class="hljs-number">2</span>, <span class="hljs-attribute">ctx</span>:<span class="hljs-string">"2d"</span>}
    <span class="hljs-attribute">agents</span>:    {<span class="hljs-attribute">z</span>:<span class="hljs-number">3</span>, <span class="hljs-attribute">ctx</span>:<span class="hljs-string">"2d"</span>}
    <span class="hljs-attribute">spotlight</span>: {<span class="hljs-attribute">z</span>:<span class="hljs-number">4</span>, <span class="hljs-attribute">ctx</span>:<span class="hljs-string">"2d"</span>}
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>Constructor: </p>
<ul>
<li>create agentsets, install them and ourselves in ABM global namespace</li>
<li>create layers/contexts, install drawing layer in ABM global namespace</li>
<li>setup patch coord transforms for each layer context</li>
<li>intialize various instance variables</li>
<li>call <code>setup</code> abstract method</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">constructor</span>: (
    <span class="hljs-property">@div</span>, size, minX, maxX, minY, maxY,
    isTorus=<span class="hljs-literal">true</span>, hasNeighbors=<span class="hljs-literal">true</span>
  )<span class="hljs-function"> -&gt;</span>
    ABM.model = @ <span class="hljs-comment">#; numX = maxX-minX+1; numY = maxY-minY+1    </span>
    <span class="hljs-property">@setWorld</span> size, minX, maxX, minY, maxY, isTorus, hasNeighbors
    <span class="hljs-property">@contexts</span> = ABM.contexts = {}</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <ul>
<li>Create 2D canvas contexts layered on top of each other.</li>
<li>Initialize a patch coord transform for each layer.</li>
</ul>
<p>Note: this is permanent .. there isn’t the usual ctx.restore().
To use the original canvas 2D transform temporarily:</p>
<pre><code>u.setIdentity ctx
  &lt;draw <span class="hljs-keyword">in</span> <span class="hljs-reserved">native</span> coord system&gt;
ctx.restore() <span class="hljs-comment"># restore patch coord system</span>
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>    
    <span class="hljs-keyword">for</span> own k,v <span class="hljs-keyword">of</span> <span class="hljs-property">@contextsInit</span>
      <span class="hljs-property">@addContext</span> k, v.z, v.ctx</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>One of the layers is used for drawing only, not an agentset:</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-property">@drawing</span> = ABM.drawing = <span class="hljs-property">@contexts</span>.drawing</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>Setup spotlight layer, also not an agentset:</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-property">@contexts</span>.spotlight.globalCompositeOperation = <span class="hljs-string">"xor"</span></pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>Initialize animator to default: 30fps, not async</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-property">@anim</span> = <span class="hljs-keyword">new</span> ABM.Animator(@)</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>Set drawing controls.  Default to drawing each agentset.
Optimization: If any of these is set to false, the associated
agentset is drawn only once, remaining static after that.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-property">@refreshLinks</span> = <span class="hljs-property">@refreshAgents</span> = <span class="hljs-property">@refreshPatches</span> = <span class="hljs-literal">true</span></pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>Initialize agentsets.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-property">@patches</span> = ABM.patches = <span class="hljs-keyword">new</span> ABM.Patches ABM.Patch, <span class="hljs-string">"patches"</span>
    <span class="hljs-property">@agents</span> = ABM.agents = <span class="hljs-keyword">new</span> ABM.Agents ABM.Agent, <span class="hljs-string">"agents"</span>
    <span class="hljs-property">@links</span> = ABM.links = <span class="hljs-keyword">new</span> ABM.Links ABM.Link, <span class="hljs-string">"links"</span></pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>Call the models setup function. Set the list of global variables to
the new variables created by setup(). Do not include agentsets, they
are available in the ABM global.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-property">@setup</span>()</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p>add a new canvas layer/context</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">addContext</span>: <span class="hljs-function"><span class="hljs-params">(name, z, ctx=<span class="hljs-string">"2d"</span>)</span>-&gt;</span>
      <span class="hljs-property">@contexts</span>[name] = ctx = u.createLayer <span class="hljs-property">@div</span>, <span class="hljs-property">@world</span>.width, <span class="hljs-property">@world</span>.height, z, ctx
      <span class="hljs-property">@setCtxTransform</span>(ctx)
      <span class="hljs-keyword">return</span> ctx</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p>Stop and reset the model</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">reset</span>: <span class="hljs-function"><span class="hljs-params">()</span> -&gt;</span> 
    <span class="hljs-property">@anim</span>.reset() <span class="hljs-comment"># stop &amp; reset ticks/steps counters</span>
    <span class="hljs-property">@patches</span> = ABM.patches = <span class="hljs-keyword">new</span> ABM.Patches ABM.Patch, <span class="hljs-string">"patches"</span>
    <span class="hljs-property">@agents</span> = ABM.agents = <span class="hljs-keyword">new</span> ABM.Agents ABM.Agent, <span class="hljs-string">"agents"</span>
    <span class="hljs-property">@links</span> = ABM.links = <span class="hljs-keyword">new</span> ABM.Links ABM.Link, <span class="hljs-string">"links"</span>
    <span class="hljs-property">@setCtxTransform</span> v <span class="hljs-keyword">for</span> k,v <span class="hljs-keyword">of</span> <span class="hljs-property">@contexts</span> <span class="hljs-comment"># clear/resize all contexts</span>
    <span class="hljs-property">@setSpotlight</span> <span class="hljs-literal">null</span>
    <span class="hljs-property">@contexts</span>.spotlight.globalCompositeOperation = <span class="hljs-string">"xor"</span>
    u.s.spriteSheets.length = <span class="hljs-number">0</span> <span class="hljs-comment"># possibly null out entries?</span></pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p>reset, then setup and start the model</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">restart</span>:<span class="hljs-function"> -&gt;</span> <span class="hljs-property">@reset</span>(); <span class="hljs-property">@setup</span>(); <span class="hljs-property">@start</span>()</pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <p>Initialize/reset world parameters.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">setWorld</span>: <span class="hljs-function"><span class="hljs-params">(size, minX, maxX, minY, maxY, isTorus=<span class="hljs-literal">true</span>, hasNeighbors=<span class="hljs-literal">true</span>)</span> -&gt;</span>
    numX = maxX-minX+<span class="hljs-number">1</span>; numY = maxY-minY+<span class="hljs-number">1</span>; width = numX*size; height = numY*size
    ABM.world = <span class="hljs-property">@world</span> = {size,minX,maxX,minY,maxY,numX,numY,width,height,isTorus,hasNeighbors}
  <span class="hljs-attribute">setCtxTransform</span>: <span class="hljs-function"><span class="hljs-params">(ctx)</span> -&gt;</span>
    ctx.canvas.width = <span class="hljs-property">@world</span>.width; ctx.canvas.height = <span class="hljs-property">@world</span>.height
    ctx.save()
    ctx.scale <span class="hljs-property">@world</span>.size, -<span class="hljs-property">@world</span>.size
    ctx.translate -(<span class="hljs-property">@world</span>.minX-<span class="hljs-number">.5</span>), -(<span class="hljs-property">@world</span>.maxY+<span class="hljs-number">.5</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <h3 id="optimizations-">Optimizations:</h3>

            </div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <p>Modelers “tune” their model by adjusting flags:<br>
<code>@refreshLinks, @refreshAgents, @refreshPatches</code><br>
and by the following methods:</p>

            </div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <p>Draw patches using scaled image of colors. Note anti-aliasing may occur
if browser does not support imageSmoothingEnabled or equivalent.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">setFastPatches</span>:<span class="hljs-function"> -&gt;</span> <span class="hljs-property">@patches</span>.usePixels()</pre></div></div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <p>Have patches cache the agents currently on them.
Optimizes Patch p.agentsHere method</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">setCacheAgentsHere</span>:<span class="hljs-function"> -&gt;</span> <span class="hljs-property">@patches</span>.cacheAgentsHere()</pre></div></div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <p>Have agents cache the links with them as a node.
Optimizes Agent a.myLinks method</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">setCacheMyLinks</span>:<span class="hljs-function"> -&gt;</span> <span class="hljs-property">@agents</span>.cacheLinks()</pre></div></div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              <p>Have patches cache the given patchRect.
Optimizes patchRect, inRadius and inCone</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">setCachePatchRects</span>: <span class="hljs-function"><span class="hljs-params">(radius, meToo=<span class="hljs-literal">false</span>)</span> -&gt;</span> <span class="hljs-property">@patches</span>.cacheRect radius, meToo</pre></div></div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
              <h3 id="text-utilities-">Text Utilities:</h3>

            </div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-35">&#182;</a>
              </div>
              <p>Set the text parameters for an agentset’s context.  See ABM.util.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">setTextParams</span>: <span class="hljs-function"><span class="hljs-params">(agentset, domFont, align=<span class="hljs-string">"center"</span>, baseline=<span class="hljs-string">"middle"</span>)</span> -&gt;</span>
    u.ctxTextParams <span class="hljs-property">@contexts</span>[agentset.name], domFont, align, baseline
  <span class="hljs-attribute">setLabelParams</span>: <span class="hljs-function"><span class="hljs-params">(agentset, color, xy)</span> -&gt;</span>
    u.ctxLabelParams <span class="hljs-property">@contexts</span>[agentset.name], color, xy</pre></div></div>
            
        </li>
        
        
        <li id="section-36">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-36">&#182;</a>
              </div>
              <h3 id="user-model-creation">User Model Creation</h3>
<p>A user’s model is made by subclassing Model and over-riding these
two abstract methods. <code>super</code> need not be called.</p>

            </div>
            
        </li>
        
        
        <li id="section-37">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-37">&#182;</a>
              </div>
              <p>Initialize your model here.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">setup</span>:<span class="hljs-function"> -&gt;</span> <span class="hljs-comment"># called at the end of model creation</span></pre></div></div>
            
        </li>
        
        
        <li id="section-38">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-38">&#182;</a>
              </div>
              <p>Update/step your model here</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">step</span>:<span class="hljs-function"> -&gt;</span> <span class="hljs-comment"># called each step of the animation</span></pre></div></div>
            
        </li>
        
        
        <li id="section-39">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-39">&#182;</a>
              </div>
              <p>Convenience access to animator:</p>

            </div>
            
        </li>
        
        
        <li id="section-40">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-40">&#182;</a>
              </div>
              <p>Start/stop the animation</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">start</span>:<span class="hljs-function"> -&gt;</span> <span class="hljs-property">@anim</span>.start()
  <span class="hljs-attribute">stop</span>:<span class="hljs-function"> -&gt;</span> <span class="hljs-property">@anim</span>.stop()</pre></div></div>
            
        </li>
        
        
        <li id="section-41">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-41">&#182;</a>
              </div>
              <p>Animate once by <code>step(); draw()</code>. For debugging from console.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">once</span>:<span class="hljs-function"> -&gt;</span> <span class="hljs-property">@anim</span>.once()</pre></div></div>
            
        </li>
        
        
        <li id="section-42">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-42">&#182;</a>
              </div>
              <h3 id="animation-">Animation.</h3>

            </div>
            
        </li>
        
        
        <li id="section-43">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-43">&#182;</a>
              </div>
              <p>Call the agentset draw methods if either the first draw call or
their “refresh” flags are set.  The latter are simple optimizations
to avoid redrawing the same static scene. Called by animator.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">draw</span>:<span class="hljs-function"> -&gt;</span>
    <span class="hljs-property">@patches</span>.draw <span class="hljs-property">@contexts</span>.patches  <span class="hljs-keyword">if</span> <span class="hljs-property">@refreshPatches</span> <span class="hljs-keyword">or</span> <span class="hljs-property">@anim</span>.draws <span class="hljs-keyword">is</span> <span class="hljs-number">1</span>
    <span class="hljs-property">@links</span>.draw   <span class="hljs-property">@contexts</span>.links    <span class="hljs-keyword">if</span> <span class="hljs-property">@refreshLinks</span>   <span class="hljs-keyword">or</span> <span class="hljs-property">@anim</span>.draws <span class="hljs-keyword">is</span> <span class="hljs-number">1</span>
    <span class="hljs-property">@agents</span>.draw  <span class="hljs-property">@contexts</span>.agents   <span class="hljs-keyword">if</span> <span class="hljs-property">@refreshAgents</span>  <span class="hljs-keyword">or</span> <span class="hljs-property">@anim</span>.draws <span class="hljs-keyword">is</span> <span class="hljs-number">1</span>
    <span class="hljs-property">@drawSpotlight</span> <span class="hljs-property">@spotlightAgent</span>, <span class="hljs-property">@contexts</span>.spotlight  <span class="hljs-keyword">if</span> <span class="hljs-property">@spotlightAgent</span>?</pre></div></div>
            
        </li>
        
        
        <li id="section-44">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-44">&#182;</a>
              </div>
              <p>Creates a spotlight effect on an agent, so we can follow it throughout the model.
Use:</p>
<pre><code><span class="hljs-property">@setSpotlight</span> breed.oneOf()
</code></pre><p>to draw one of a random breed. Remove spotlight by passing <code>null</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">setSpotlight</span>: <span class="hljs-function"><span class="hljs-params">(<span class="hljs-property">@spotlightAgent</span>)</span> -&gt;</span>
    u.clearCtx <span class="hljs-property">@contexts</span>.spotlight <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-property">@spotlightAgent</span>?

  <span class="hljs-attribute">drawSpotlight</span>: <span class="hljs-function"><span class="hljs-params">(agent, ctx)</span> -&gt;</span>
    u.clearCtx ctx
    u.fillCtx ctx, [<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0.6</span>]
    ctx.beginPath()
    ctx.arc agent.x, agent.y, (<span class="hljs-property">@spotlightRadius</span> || <span class="hljs-number">3</span>), <span class="hljs-number">0</span>, <span class="hljs-number">2</span>*Math.PI, <span class="hljs-literal">false</span>
    ctx.fill()</pre></div></div>
            
        </li>
        
        
        <li id="section-45">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-45">&#182;</a>
              </div>
              <h3 id="breeds">Breeds</h3>

            </div>
            
        </li>
        
        
        <li id="section-46">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-46">&#182;</a>
              </div>
              <p>Three versions of NL’s <code>breed</code> commands.</p>
<pre><code><span class="hljs-property">@patchBreeds</span> <span class="hljs-string">"streets buildings"</span>
<span class="hljs-property">@agentBreeds</span> <span class="hljs-string">"embers fires"</span>
<span class="hljs-property">@linkBreeds</span> <span class="hljs-string">"spokes rims"</span>
</code></pre><p>will create 6 agentSets: </p>
<pre><code><span class="hljs-property">@streets</span> <span class="hljs-keyword">and</span> <span class="hljs-property">@buildings</span>
<span class="hljs-property">@embers</span> <span class="hljs-keyword">and</span> <span class="hljs-property">@fires</span>
<span class="hljs-property">@spokes</span> <span class="hljs-keyword">and</span> <span class="hljs-property">@rims</span> 
</code></pre><p>These agentset’s <code>create</code> method create subclasses of Agent/Link.
Use of <breed>.setDefault methods work as for agents/links, creating default
values for the breed set:</p>
<pre><code><span class="hljs-property">@embers</span>.setDefaultColor [<span class="hljs-number">255</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>]
</code></pre><p>..will set the default color for just the embers.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  
  <span class="hljs-attribute">createBreeds</span>: <span class="hljs-function"><span class="hljs-params">(s, agentClass, breedSet)</span> -&gt;</span>
    breeds = []; breeds.classes = {}; breeds.sets = {}
    <span class="hljs-keyword">for</span> b <span class="hljs-keyword">in</span> s.split(<span class="hljs-string">" "</span>)
      c = <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Breed</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">agentClass</span></span>
      @[b] = <span class="hljs-comment"># add @&lt;breed&gt; to local scope</span>
        <span class="hljs-keyword">new</span> breedSet c, b, <span class="hljs-attribute">agentClass</span>::breed <span class="hljs-comment"># create subset agentSet</span>
      breeds.push @[b]
      breeds.sets[b] = @[b]
      breeds.classes[<span class="hljs-string">"<span class="hljs-subst">#{b}</span>Class"</span>] = c
    breeds
  <span class="hljs-attribute">patchBreeds</span>: <span class="hljs-function"><span class="hljs-params">(s)</span> -&gt;</span> ABM.patchBreeds = <span class="hljs-property">@createBreeds</span> s, ABM.Patch, ABM.Patches
  <span class="hljs-attribute">agentBreeds</span>: <span class="hljs-function"><span class="hljs-params">(s)</span> -&gt;</span> ABM.agentBreeds = <span class="hljs-property">@createBreeds</span> s, ABM.Agent, ABM.Agents
  <span class="hljs-attribute">linkBreeds</span>:  <span class="hljs-function"><span class="hljs-params">(s)</span> -&gt;</span> ABM.linkBreeds  = <span class="hljs-property">@createBreeds</span> s, ABM.Link,  ABM.Links</pre></div></div>
            
        </li>
        
        
        <li id="section-47">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-47">&#182;</a>
              </div>
              <p>Utility for models to create agentsets from arrays.  Ex:</p>
<pre><code>even = <span class="hljs-property">@asSet</span> (a <span class="hljs-keyword">for</span> a <span class="hljs-keyword">in</span> <span class="hljs-property">@agents</span> <span class="hljs-keyword">when</span> a.id % <span class="hljs-number">2</span> <span class="hljs-keyword">is</span> <span class="hljs-number">0</span>)
even.shuffle().getProp(<span class="hljs-string">"id"</span>) <span class="hljs-comment"># [6, 0, 4, 2, 8]</span>
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">asSet</span>: <span class="hljs-function"><span class="hljs-params">(a)</span> -&gt;</span> <span class="hljs-comment"># turns an array into an agent set</span>
    ABM.AgentSet.asSet(a)</pre></div></div>
            
        </li>
        
        
        <li id="section-48">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-48">&#182;</a>
              </div>
              <p>A simple debug aid which places short names in the global name space.
Note we avoid using the actual name, such as “patches” because this
can cause our modules to mistakenly depend on a global name.
See <a href="http://goo.gl/1i7bd">CoffeeConsole</a> Chrome extension too.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">setRootVars</span>:<span class="hljs-function"> -&gt;</span>
    root.ps  = <span class="hljs-property">@patches</span>
    root.p0  = <span class="hljs-property">@patches</span>[<span class="hljs-number">0</span>]
    root.as  = <span class="hljs-property">@agents</span>
    root.a0  = <span class="hljs-property">@agents</span>[<span class="hljs-number">0</span>]
    root.ls  = <span class="hljs-property">@links</span>
    root.l0  = <span class="hljs-property">@links</span>[<span class="hljs-number">0</span>]
    root.dr  = <span class="hljs-property">@drawing</span>
    root.u   = ABM.util
    root.sh  = ABM.shapes
    root.app = @
    root.cx  = <span class="hljs-property">@contexts</span>
    root.ab  = ABM.agentBreeds
    root.lb  = ABM.linkBreeds
    root.an  = <span class="hljs-property">@anim</span>
    root.wd  = ABM.world
    root.gl  = <span class="hljs-property">@globals</span>
    root.root= root
    <span class="hljs-literal">null</span></pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
