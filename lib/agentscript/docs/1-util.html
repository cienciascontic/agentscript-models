<!DOCTYPE html>

<html>
<head>
  <title>1-util.coffee</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="1-util.html">
                1-util.coffee
              </a>
            
              
              <a class="source" href="2-shapes.html">
                2-shapes.coffee
              </a>
            
              
              <a class="source" href="3-agentset.html">
                3-agentset.coffee
              </a>
            
              
              <a class="source" href="4-agentsets.html">
                4-agentsets.coffee
              </a>
            
              
              <a class="source" href="5-model.html">
                5-model.coffee
              </a>
            
              
              <a class="source" href="6-template.html">
                6-template.coffee
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>1-util.coffee</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <p>This documentation uses Jeremy Ashkenas’s
<a href="http://jashkenas.github.com/docco/">docco</a> which allows
<a href="http://daringfireball.net/projects/markdown/syntax">markdown</a>.</p>

            </div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>Create the namespace <strong>ABM</strong> for our project.
Note here <code>this</code> or <code>@</code> == window due to coffeescript wrapper call.
Thus @ABM is placed in the global scope.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-property">@ABM</span>={}

root = @ <span class="hljs-comment"># Keep a private copy of global object</span></pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>Global shim for not-yet-standard requestAnimationFrame.
See: <a href="https://gist.github.com/paulirish/1579671">Paul Irish Shim</a></p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">do</span><span class="hljs-function"> -&gt;</span> 
  <span class="hljs-property">@requestAnimFrame</span> = <span class="hljs-property">@requestAnimationFrame</span> <span class="hljs-keyword">or</span> <span class="hljs-literal">null</span>
  <span class="hljs-property">@cancelAnimFrame</span> = <span class="hljs-property">@cancelAnimationFrame</span> <span class="hljs-keyword">or</span> <span class="hljs-literal">null</span>
  <span class="hljs-keyword">for</span> vendor <span class="hljs-keyword">in</span> [<span class="hljs-string">'ms'</span>, <span class="hljs-string">'moz'</span>, <span class="hljs-string">'webkit'</span>, <span class="hljs-string">'o'</span>] <span class="hljs-keyword">when</span> <span class="hljs-keyword">not</span> <span class="hljs-property">@requestAnimFrame</span>
    <span class="hljs-property">@requestAnimFrame</span> <span class="hljs-keyword">or</span>= @[vendor+<span class="hljs-string">'RequestAnimationFrame'</span>]
    <span class="hljs-property">@cancelAnimFrame</span> <span class="hljs-keyword">or</span>= @[vendor+<span class="hljs-string">'CancelAnimationFrame'</span>]
    <span class="hljs-property">@cancelAnimFrame</span> <span class="hljs-keyword">or</span>= @[vendor+<span class="hljs-string">'CancelRequestAnimationFrame'</span>]
  <span class="hljs-property">@requestAnimFrame</span> <span class="hljs-function"><span class="hljs-title">or</span>= <span class="hljs-params">(callback)</span> -&gt;</span> <span class="hljs-property">@setTimeout</span>(callback, <span class="hljs-number">1000</span> / <span class="hljs-number">60</span>)
  <span class="hljs-property">@cancelAnimFrame</span> <span class="hljs-function"><span class="hljs-title">or</span>= <span class="hljs-params">(id)</span> -&gt;</span> <span class="hljs-property">@clearTimeout</span>(id)</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>Shim for <code>Array.indexOf</code> if not implemented.
Use <a href="https://github.com/kriskowal/es5-shim">es5-shim</a> if additional shims needed.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-attribute">Array</span>::indexOf <span class="hljs-function"><span class="hljs-title">or</span>= <span class="hljs-params">(item)</span> -&gt;</span> <span class="hljs-keyword">return</span> i <span class="hljs-keyword">if</span> x <span class="hljs-keyword">is</span> item <span class="hljs-keyword">for</span> x, i <span class="hljs-keyword">in</span> @; -<span class="hljs-number">1</span></pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p><strong>ABM.util</strong> contains the general utilities for the project. Note that within
<strong>util</strong> <code>@</code> referrs to ABM.util, <em>not</em> the global name space as above.
Alias: u is an alias for ABM.util within the agentscript module (not outside)</p>
<pre><code> u.clearCtx(ctx) <span class="hljs-keyword">is</span> equivalent to
 ABM.util.clearCtx(ctx)
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>
ABM.util = u =</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>Shortcut for throwing an error.  Good for debugging:</p>
<pre><code>error(<span class="hljs-string">"wtf? foo=<span class="hljs-subst">#{foo}</span>"</span>) <span class="hljs-keyword">if</span> fooProblem
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">error</span>: <span class="hljs-function"><span class="hljs-params">(s)</span> -&gt;</span> <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Error s</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>Good replacements for Javascript’s badly broken<code>typeof</code> and <code>instanceof</code>
See <a href="http://goo.gl/L0umK">underscore.coffee</a></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">isArray</span>: Array.isArray <span class="hljs-keyword">or</span> <span class="hljs-comment"># works with agentSets too</span>
    <span class="hljs-function"><span class="hljs-params">(obj)</span> -&gt;</span> !!(obj <span class="hljs-keyword">and</span> obj.concat <span class="hljs-keyword">and</span> obj.unshift <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> obj.callee)
  <span class="hljs-attribute">isFunction</span>: <span class="hljs-function"><span class="hljs-params">(obj)</span> -&gt;</span> 
    !!(obj <span class="hljs-keyword">and</span> obj.constructor <span class="hljs-keyword">and</span> obj.call <span class="hljs-keyword">and</span> obj.apply)
  <span class="hljs-attribute">isString</span>: <span class="hljs-function"><span class="hljs-params">(obj)</span> -&gt;</span> 
    !!(obj <span class="hljs-keyword">is</span> <span class="hljs-string">''</span> <span class="hljs-keyword">or</span> (obj <span class="hljs-keyword">and</span> obj.charCodeAt <span class="hljs-keyword">and</span> obj.substr))
  <span class="hljs-attribute">isEarlyIE</span>:<span class="hljs-function"> -&gt;</span>
    <span class="hljs-keyword">return</span> navigator.appVersion.indexOf(<span class="hljs-string">"MSIE 9"</span>) <span class="hljs-keyword">isnt</span> -<span class="hljs-number">1</span> <span class="hljs-keyword">or</span>
           navigator.appVersion.indexOf(<span class="hljs-string">"MSIE 10"</span>) <span class="hljs-keyword">isnt</span> -<span class="hljs-number">1</span></pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <h3 id="numeric-operations">Numeric Operations</h3>

            </div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>Return random int in [0,max) or [min,max)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">randomInt</span>: <span class="hljs-function"><span class="hljs-params">(max)</span> -&gt;</span> Math.floor(Math.random() * max)
  <span class="hljs-attribute">randomInt2</span>: <span class="hljs-function"><span class="hljs-params">(min, max)</span> -&gt;</span> min + Math.floor(Math.random() * (max-min))</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>Return float Gaussian normal with given mean, std deviation.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">randomNormal</span>: <span class="hljs-function"><span class="hljs-params">(mean = <span class="hljs-number">0.0</span>, sigma = <span class="hljs-number">1.0</span>)</span> -&gt;</span> <span class="hljs-comment"># Box-Muller</span>
    u1 = <span class="hljs-number">1.0</span>-Math.random(); u2 = Math.random() <span class="hljs-comment"># u1 in (0,1]</span>
    norm = Math.sqrt(-<span class="hljs-number">2.0</span>*Math.log(u1)) * Math.cos(<span class="hljs-number">2.0</span>*Math.PI*u2)
    norm*sigma + mean</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>Return float in [0,max) or [min,max) or [-r/2,r/2)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">randomFloat</span>: <span class="hljs-function"><span class="hljs-params">(max)</span> -&gt;</span> Math.random() * max
  <span class="hljs-attribute">randomFloat2</span>: <span class="hljs-function"><span class="hljs-params">(min, max)</span> -&gt;</span> min + Math.random() * (max-min)
  <span class="hljs-attribute">randomCentered</span>: <span class="hljs-function"><span class="hljs-params">(r)</span> -&gt;</span> <span class="hljs-property">@randomFloat2</span> -r/<span class="hljs-number">2</span>, r/<span class="hljs-number">2</span></pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>Return log n where base is 10, base, e respectively</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">log10</span>: <span class="hljs-function"><span class="hljs-params">(n)</span> -&gt;</span> Math.log(n)/Math.LN10
  <span class="hljs-attribute">logN</span>: <span class="hljs-function"><span class="hljs-params">(n, base)</span> -&gt;</span> Math.log(n)/Math.log(base)</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>Note: ln: (n) -&gt; Math.log n
Return true <a href="http://goo.gl/spr24">mod functin</a>, % is remainder, not mod.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">mod</span>: <span class="hljs-function"><span class="hljs-params">(v, n)</span> -&gt;</span> ((v % n) + n) % n</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>Return v to be between min, max via mod fcn</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">wrap</span>: <span class="hljs-function"><span class="hljs-params">(v, min, max)</span> -&gt;</span> min + <span class="hljs-property">@mod</span>(v-min, max-min)</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>Return v to be between min, max via clamping with min/max</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">clamp</span>: <span class="hljs-function"><span class="hljs-params">(v, min, max)</span> -&gt;</span> Math.max(Math.min(v,max),min)</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>Return sign of a number as +/- 1</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">sign</span>: <span class="hljs-function"><span class="hljs-params">(v)</span> -&gt;</span> <span class="hljs-keyword">return</span> (<span class="hljs-keyword">if</span> v&lt;<span class="hljs-number">0</span> <span class="hljs-keyword">then</span> -<span class="hljs-number">1</span> <span class="hljs-keyword">else</span> <span class="hljs-number">1</span>) <span class="hljs-comment"># retrun exp: force ?: JS form</span></pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>Return a float array with given precision; useful for printing</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">aToFixed</span>: <span class="hljs-function"><span class="hljs-params">(a, p=<span class="hljs-number">2</span>)</span> -&gt;</span> (i.toFixed p <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> a)</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <h3 id="color-and-angle-operations">Color and Angle Operations</h3>
<p>Our colors are r,g,b,[a] arrays, with an optional color.str HTML
color string property. The str value is set on the first call to colorStr</p>

            </div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>Return a random RGB or gray color. Array passed to minimize garbage collection</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">randomColor</span>: <span class="hljs-function"><span class="hljs-params">(c = [])</span> -&gt;</span> 
    c.str = <span class="hljs-literal">null</span> <span class="hljs-keyword">if</span> c.str?
    c[i] = <span class="hljs-property">@randomInt</span>(<span class="hljs-number">256</span>) <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> [<span class="hljs-number">0.</span><span class="hljs-number">.2</span>]
    c</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>Note: if 2 args passed, assume they’re min, max w/ default c</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">randomGray</span>: <span class="hljs-function"><span class="hljs-params">(c = [], min = <span class="hljs-number">64</span>, max = <span class="hljs-number">192</span>)</span> -&gt;</span> 
    <span class="hljs-keyword">if</span> arguments.length <span class="hljs-keyword">is</span> <span class="hljs-number">2</span> <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> <span class="hljs-property">@randomGray</span> <span class="hljs-literal">null</span>, c, min
    c.str = <span class="hljs-literal">null</span> <span class="hljs-keyword">if</span> c.str?
    r=<span class="hljs-property">@randomInt2</span> min,max
    c[i] = r <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> [<span class="hljs-number">0.</span><span class="hljs-number">.2</span>]
    c</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>Random color from a colormap set of r,g,b values, default is one of 125 (5^3) colors</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">randomMapColor</span>: <span class="hljs-function"><span class="hljs-params">(c = [], set = [<span class="hljs-number">0</span>,<span class="hljs-number">63</span>,<span class="hljs-number">127</span>,<span class="hljs-number">191</span>,<span class="hljs-number">255</span>])</span> -&gt;</span> 
    <span class="hljs-property">@setColor</span> c, u.oneOf(set), u.oneOf(set), u.oneOf(set)
  <span class="hljs-attribute">randomBrightColor</span>: <span class="hljs-function"><span class="hljs-params">(c=[])</span> -&gt;</span> <span class="hljs-property">@randomMapColor</span> c, [<span class="hljs-number">0</span>,<span class="hljs-number">127</span>,<span class="hljs-number">255</span>]</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>Modify an existing color. Modifying an existing array minimizes GC overhead</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">setColor</span>: <span class="hljs-function"><span class="hljs-params">(c, r, g, b, a)</span> -&gt;</span>
    c.str = <span class="hljs-literal">null</span> <span class="hljs-keyword">if</span> c.str?
    c[<span class="hljs-number">0</span>] = r; c[<span class="hljs-number">1</span>] = g; c[<span class="hljs-number">2</span>] = b; c[<span class="hljs-number">3</span>] = a <span class="hljs-keyword">if</span> a?
    c</pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>Return new color, c, by scaling each value of the rgb color max.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">scaleColor</span>: <span class="hljs-function"><span class="hljs-params">(max, s, c = [])</span> -&gt;</span> 
    c.str = <span class="hljs-literal">null</span> <span class="hljs-keyword">if</span> c.str?
    c[i] = <span class="hljs-property">@clamp</span>(Math.round(val*s),<span class="hljs-number">0</span>,<span class="hljs-number">255</span>) <span class="hljs-keyword">for</span> val, i <span class="hljs-keyword">in</span> max <span class="hljs-comment"># [r,g,b] must be ints</span>
    c</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p>Return HTML color as used by canvas element.  Can include Alpha</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">colorStr</span>: <span class="hljs-function"><span class="hljs-params">(c)</span> -&gt;</span>
    <span class="hljs-keyword">return</span> s <span class="hljs-keyword">if</span> (s = c.str)?
    c.str = <span class="hljs-keyword">if</span> c.length <span class="hljs-keyword">is</span> <span class="hljs-number">3</span> <span class="hljs-keyword">then</span> <span class="hljs-string">"rgb(<span class="hljs-subst">#{c}</span>)"</span> <span class="hljs-keyword">else</span> <span class="hljs-string">"rgba(<span class="hljs-subst">#{c}</span>)"</span></pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p>Compare two colors.  Alas, there is no array.Equal operator.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">colorsEqual</span>: <span class="hljs-function"><span class="hljs-params">(c1, c2)</span> -&gt;</span> c1.toString() <span class="hljs-keyword">is</span> c2.toString()</pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p>Return little/big endian-ness of hardware. 
See Mozilla pixel <a href="http://goo.gl/Lxliq">manipulation article</a></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">isLittleEndian</span>:<span class="hljs-function"> -&gt;</span>
    d8 = <span class="hljs-keyword">new</span> Uint8ClampedArray <span class="hljs-number">4</span>
    d32 = <span class="hljs-keyword">new</span> Uint32Array d8.buffer
    d32[<span class="hljs-number">0</span>] = <span class="hljs-number">0x01020304</span>
    d8[<span class="hljs-number">0</span>] <span class="hljs-keyword">is</span> <span class="hljs-number">4</span></pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <p>Convert between degrees and radians.  We/Math package use radians.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">degToRad</span>: <span class="hljs-function"><span class="hljs-params">(degrees)</span> -&gt;</span> degrees * Math.PI / <span class="hljs-number">180</span>
  <span class="hljs-attribute">radToDeg</span>: <span class="hljs-function"><span class="hljs-params">(radians)</span> -&gt;</span> radians * <span class="hljs-number">180</span> / Math.PI</pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <p>Return angle in (-pi,pi] that added to rad2 = rad1</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">subtractRads</span>: <span class="hljs-function"><span class="hljs-params">(rad1, rad2)</span> -&gt;</span>
    dr = rad1-rad2; PI = Math.PI
    dr += <span class="hljs-number">2</span>*PI <span class="hljs-keyword">if</span> dr &lt;= -PI; dr -= <span class="hljs-number">2</span>*PI <span class="hljs-keyword">if</span> dr &gt; PI; dr</pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <h3 id="object-operations">Object Operations</h3>

            </div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <p>Return object’s own variable names, less function in second version</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">ownKeys</span>: <span class="hljs-function"><span class="hljs-params">(obj)</span> -&gt;</span> key <span class="hljs-keyword">for</span> own key, value <span class="hljs-keyword">of</span> obj
  <span class="hljs-attribute">ownVarKeys</span>: <span class="hljs-function"><span class="hljs-params">(obj)</span> -&gt;</span> key <span class="hljs-keyword">for</span> own key, value <span class="hljs-keyword">of</span> obj <span class="hljs-keyword">when</span> <span class="hljs-keyword">not</span> <span class="hljs-property">@isFunction</span> value</pre></div></div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <h3 id="array-operations">Array Operations</h3>

            </div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <p>Does the array have any elements? Is the array empty?</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">any</span>: <span class="hljs-function"><span class="hljs-params">(array)</span> -&gt;</span> array.length <span class="hljs-keyword">isnt</span> <span class="hljs-number">0</span>
  <span class="hljs-attribute">empty</span>: <span class="hljs-function"><span class="hljs-params">(array)</span> -&gt;</span> array.length <span class="hljs-keyword">is</span> <span class="hljs-number">0</span></pre></div></div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              <p>Make a copy of the array. Needed when you don’t want to modify the given
array with mutator methods like sort, splice or your own functions.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">clone</span>: <span class="hljs-function"><span class="hljs-params">(array)</span> -&gt;</span> array.slice <span class="hljs-number">0</span></pre></div></div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
              <p>Return last element of array.  Error if empty.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">last</span>: <span class="hljs-function"><span class="hljs-params">(array)</span> -&gt;</span> 
    <span class="hljs-property">@error</span> <span class="hljs-string">"last: empty array"</span> <span class="hljs-keyword">if</span> <span class="hljs-property">@empty</span> array
    array[array.length-<span class="hljs-number">1</span>]</pre></div></div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-35">&#182;</a>
              </div>
              <p>Return random element of array.  Error if empty.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">oneOf</span>: <span class="hljs-function"><span class="hljs-params">(array)</span> -&gt;</span> 
    <span class="hljs-property">@error</span> <span class="hljs-string">"oneOf: empty array"</span> <span class="hljs-keyword">if</span> <span class="hljs-property">@empty</span> array
    array[<span class="hljs-property">@randomInt</span> array.length]</pre></div></div>
            
        </li>
        
        
        <li id="section-36">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-36">&#182;</a>
              </div>
              <p>Return n random elements of array.  Error if n &gt; array size.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">nOf</span>: <span class="hljs-function"><span class="hljs-params">(array, n)</span> -&gt;</span> <span class="hljs-comment"># Note: clone, shuffle then first n may be better</span>
    <span class="hljs-property">@error</span> <span class="hljs-string">"nOf: n &gt; length"</span> <span class="hljs-keyword">if</span> n &gt; array.length
    r = []; <span class="hljs-keyword">while</span> r.length &lt; n
      o = <span class="hljs-property">@oneOf</span>(array)
      r.push o <span class="hljs-keyword">unless</span> o <span class="hljs-keyword">in</span> r
    r
  <span class="hljs-attribute">contains</span>: <span class="hljs-function"><span class="hljs-params">(array, item)</span> -&gt;</span> -<span class="hljs-number">1</span> <span class="hljs-keyword">isnt</span> array.indexOf item</pre></div></div>
            
        </li>
        
        
        <li id="section-37">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-37">&#182;</a>
              </div>
              <p>Remove an item from an array. Error if item not in array.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">removeItem</span>: <span class="hljs-function"><span class="hljs-params">(array, item)</span> -&gt;</span>
    array.splice i, <span class="hljs-number">1</span> <span class="hljs-keyword">if</span> (i = array.indexOf item) <span class="hljs-keyword">isnt</span> -<span class="hljs-number">1</span>
    <span class="hljs-property">@error</span> <span class="hljs-string">"removeItem: item not found"</span> <span class="hljs-keyword">if</span> i &lt; <span class="hljs-number">0</span>
    i</pre></div></div>
            
        </li>
        
        
        <li id="section-38">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-38">&#182;</a>
              </div>
              <p>Randomize the elements of array.  Clever! See <a href="http://goo.gl/TT2SY">cookbook</a></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">shuffle</span>: <span class="hljs-function"><span class="hljs-params">(array)</span> -&gt;</span> array.sort<span class="hljs-function"> -&gt;</span> <span class="hljs-number">0.5</span> - Math.random()</pre></div></div>
            
        </li>
        
        
        <li id="section-39">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-39">&#182;</a>
              </div>
              <p>Return o when f(o) min/max in array. Error if array empty.
If f is a string, return element with max value of that property.
If “valueToo” then return an array of the element and the value.</p>
<pre><code>array = [{<span class="hljs-attribute">x</span>:<span class="hljs-number">1</span>,<span class="hljs-attribute">y</span>:<span class="hljs-number">2</span>}, {<span class="hljs-attribute">x</span>:<span class="hljs-number">3</span>,<span class="hljs-attribute">y</span>:<span class="hljs-number">4</span>}]
<span class="hljs-comment"># returns {x: 1, y: 2} 5</span>
[min, dist2] = minOneOf array, <span class="hljs-function"><span class="hljs-params">((o)-&gt;o.x*o.x+o.y*o.y)</span>, <span class="hljs-title">true</span>
# <span class="hljs-title">returns</span> {<span class="hljs-title">x</span>: 3, <span class="hljs-title">y</span>: 4}
<span class="hljs-title">max</span> = <span class="hljs-title">maxOneOf</span> <span class="hljs-title">array</span>, "<span class="hljs-title">x</span>"</span>
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">minOneOf</span>: <span class="hljs-function"><span class="hljs-params">(array, f, valueToo=<span class="hljs-literal">false</span>)</span> -&gt;</span>
    <span class="hljs-property">@error</span> <span class="hljs-string">"minOneOf: empty array"</span> <span class="hljs-keyword">if</span> <span class="hljs-property">@empty</span> array
    r = Infinity; o = <span class="hljs-literal">null</span>; <span class="hljs-function"><span class="hljs-params">(s=f; f = ((o)-&gt;o[s]))</span> <span class="hljs-title">if</span> @<span class="hljs-title">isString</span> <span class="hljs-title">f</span>
    <span class="hljs-title">for</span> <span class="hljs-title">a</span> <span class="hljs-title">in</span> <span class="hljs-title">array</span>
      <span class="hljs-params">(r = r1; o = a)</span> <span class="hljs-title">if</span> <span class="hljs-params">(r1=f(a))</span> &lt; <span class="hljs-title">r</span>
    <span class="hljs-title">if</span> <span class="hljs-title">valueToo</span> <span class="hljs-title">then</span> [<span class="hljs-title">o</span>, <span class="hljs-title">r</span>] <span class="hljs-title">else</span> <span class="hljs-title">o</span>
  <span class="hljs-title">maxOneOf</span>: <span class="hljs-params">(array, f, valueToo=<span class="hljs-literal">false</span>)</span> -&gt;</span>
    <span class="hljs-property">@error</span> <span class="hljs-string">"maxOneOf: empty array"</span> <span class="hljs-keyword">if</span> <span class="hljs-property">@empty</span> array
    r = -Infinity; o = <span class="hljs-literal">null</span>; <span class="hljs-function"><span class="hljs-params">(s=f; f = ((o)-&gt;o[s]))</span> <span class="hljs-title">if</span> @<span class="hljs-title">isString</span> <span class="hljs-title">f</span>
    <span class="hljs-title">for</span> <span class="hljs-title">a</span> <span class="hljs-title">in</span> <span class="hljs-title">array</span>
      <span class="hljs-params">(r = r1; o = a)</span> <span class="hljs-title">if</span> <span class="hljs-params">(r1=f(a))</span> &gt; <span class="hljs-title">r</span>
    <span class="hljs-title">if</span> <span class="hljs-title">valueToo</span> <span class="hljs-title">then</span> [<span class="hljs-title">o</span>, <span class="hljs-title">r</span>] <span class="hljs-title">else</span> <span class="hljs-title">o</span>

</span></pre></div></div>
            
        </li>
        
        
        <li id="section-40">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-40">&#182;</a>
              </div>
              <p>Return histogram of o when f(o) is a numeric value in array.
Histogram interval is bin. Error if array empty.
If f is a string, return histogram of that property.</p>
<p>In examples below, histOf returns [3,1,1,0,0,1]</p>
<pre><code>a = [<span class="hljs-number">1</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>,<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,<span class="hljs-number">10</span>]
h = histOf a, <span class="hljs-number">2</span>, <span class="hljs-function"><span class="hljs-params">(i)</span> -&gt;</span> i

b = ({<span class="hljs-attribute">id</span>:i} <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> a)
h = histOf b, <span class="hljs-number">2</span>, <span class="hljs-function"><span class="hljs-params">(o)</span> -&gt;</span> o.id
h = histOf b, <span class="hljs-number">2</span>, <span class="hljs-string">"id"</span>
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">histOf</span>: <span class="hljs-function"><span class="hljs-params">(array, bin, f)</span> -&gt;</span>
    r = []; <span class="hljs-function"><span class="hljs-params">(s=f; f = ((o)-&gt;o[s]))</span> <span class="hljs-title">if</span> @<span class="hljs-title">isString</span> <span class="hljs-title">f</span>
    <span class="hljs-title">for</span> <span class="hljs-title">a</span> <span class="hljs-title">in</span> <span class="hljs-title">array</span>
      <span class="hljs-title">i</span> = <span class="hljs-title">Math</span>.<span class="hljs-title">floor</span> <span class="hljs-title">f</span><span class="hljs-params">(a)</span>/<span class="hljs-title">bin</span>
      <span class="hljs-title">r</span>[<span class="hljs-title">i</span>] = <span class="hljs-title">if</span> <span class="hljs-params">(ri=r[i])</span>? <span class="hljs-title">then</span> <span class="hljs-title">ri</span>+1 <span class="hljs-title">else</span> 1
    <span class="hljs-title">r</span>[<span class="hljs-title">i</span>] = 0 <span class="hljs-title">for</span> <span class="hljs-title">val</span>,<span class="hljs-title">i</span> <span class="hljs-title">in</span> <span class="hljs-title">r</span> <span class="hljs-title">when</span> <span class="hljs-title">not</span> <span class="hljs-title">val</span>?
    <span class="hljs-title">r</span>

</span></pre></div></div>
            
        </li>
        
        
        <li id="section-41">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-41">&#182;</a>
              </div>
              <p>Mutator. Sorts the array of objects in place by the property. Returns array.
Clone first if you want to preserve the original array.</p>
<pre><code>array = [{<span class="hljs-attribute">i</span>:<span class="hljs-number">1</span>},{<span class="hljs-attribute">i</span>:<span class="hljs-number">5</span>},{<span class="hljs-attribute">i</span>:-<span class="hljs-number">1</span>},{<span class="hljs-attribute">i</span>:<span class="hljs-number">2</span>},{<span class="hljs-attribute">i</span>:<span class="hljs-number">2</span>}]
sortBy array, <span class="hljs-string">"i"</span>
<span class="hljs-comment"># array now is [{i:-1},{i:1},{i:2},{i:2},{i:5}]</span>
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">sortBy</span>: <span class="hljs-function"><span class="hljs-params">(array, prop)</span> -&gt;</span> array.sort <span class="hljs-function"><span class="hljs-params">(a,b)</span> -&gt;</span> a[prop] - b[prop]</pre></div></div>
            
        </li>
        
        
        <li id="section-42">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-42">&#182;</a>
              </div>
              <p>Mutator. Removes adjacent dups, by reference, in place from sorted array.
Note “by reference” means litteraly same object, not copy. Returns array.
Clone first if you want to preserve the original array.</p>
<pre><code>ids = ({<span class="hljs-attribute">id</span>:i} <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> [<span class="hljs-number">0.</span><span class="hljs-number">.10</span>])
a = (ids[i] <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> [<span class="hljs-number">1</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>,<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,<span class="hljs-number">10</span>])
<span class="hljs-comment"># a is [{id:1},{id:3},{id:4},{id:1},{id:1},{id:10}]</span>
b = clone a
sortBy b, <span class="hljs-string">"id"</span>
<span class="hljs-comment"># b is [{id:1},{id:1},{id:1},{id:3},{id:4},{id:10}]</span>
uniq b
<span class="hljs-comment"># b now is [{id:1},{id:3},{id:4},{id:10}]</span>
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">uniq</span>: <span class="hljs-function"><span class="hljs-params">(array)</span> -&gt;</span>
    array.splice i,<span class="hljs-number">1</span> <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> [array.length-<span class="hljs-number">1.</span><span class="hljs-number">.1</span>] <span class="hljs-keyword">by</span> -<span class="hljs-number">1</span> <span class="hljs-keyword">when</span> array[i-<span class="hljs-number">1</span>] <span class="hljs-keyword">is</span> array[i]
    array</pre></div></div>
            
        </li>
        
        
        <li id="section-43">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-43">&#182;</a>
              </div>
              <p>Return a new array composed of the rows of a matrix. I.e. convert</p>
<pre><code>[[<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>],[<span class="hljs-number">4</span>,<span class="hljs-number">5</span>,<span class="hljs-number">6</span>]] to [<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>,<span class="hljs-number">5</span>,<span class="hljs-number">6</span>]
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">flatten</span>: <span class="hljs-function"><span class="hljs-params">(matrix)</span> -&gt;</span> matrix.reduce<span class="hljs-function"><span class="hljs-params">( (a,b) -&gt; a.concat b )</span>
  
</span></pre></div></div>
            
        </li>
        
        
        <li id="section-44">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-44">&#182;</a>
              </div>
              <p>Return max/min/sum/avg of numeric array</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">aMax</span>: <span class="hljs-function"><span class="hljs-params">(array)</span> -&gt;</span> array.reduce <span class="hljs-function"><span class="hljs-params">(a,b)</span> -&gt;</span> Math.max a,b
  <span class="hljs-attribute">aMin</span>: <span class="hljs-function"><span class="hljs-params">(array)</span> -&gt;</span> array.reduce <span class="hljs-function"><span class="hljs-params">(a,b)</span> -&gt;</span> Math.min a,b
  <span class="hljs-attribute">aSum</span>: <span class="hljs-function"><span class="hljs-params">(array)</span> -&gt;</span> array.reduce <span class="hljs-function"><span class="hljs-params">(a,b)</span> -&gt;</span> a+b
  <span class="hljs-attribute">aMul</span>: <span class="hljs-function"><span class="hljs-params">(array)</span> -&gt;</span> array.reduce <span class="hljs-function"><span class="hljs-params">(a,b)</span> -&gt;</span> a*b
  <span class="hljs-attribute">aAvg</span>: <span class="hljs-function"><span class="hljs-params">(array)</span> -&gt;</span> <span class="hljs-property">@aSum</span>(array)/array.length</pre></div></div>
            
        </li>
        
        
        <li id="section-45">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-45">&#182;</a>
              </div>
              <p>Return array composed of f pairwise on both arrays</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">aPairwise</span>: <span class="hljs-function"><span class="hljs-params">(a1, a2, f)</span> -&gt;</span> v=<span class="hljs-number">0</span>; f(v,a2[i]) <span class="hljs-keyword">for</span> v,i <span class="hljs-keyword">in</span> a1 
  <span class="hljs-attribute">aPairSum</span>: <span class="hljs-function"><span class="hljs-params">(a1, a2)</span> -&gt;</span> <span class="hljs-property">@aPairwise</span> a1, a2, <span class="hljs-function"><span class="hljs-params">(a,b)</span>-&gt;</span>a+b
  <span class="hljs-attribute">aPairDif</span>: <span class="hljs-function"><span class="hljs-params">(a1, a2)</span> -&gt;</span> <span class="hljs-property">@aPairwise</span> a1, a2, <span class="hljs-function"><span class="hljs-params">(a,b)</span>-&gt;</span>a-b
  <span class="hljs-attribute">aPairMul</span>: <span class="hljs-function"><span class="hljs-params">(a1, a2)</span> -&gt;</span> <span class="hljs-property">@aPairwise</span> a1, a2, <span class="hljs-function"><span class="hljs-params">(a,b)</span>-&gt;</span>a*b</pre></div></div>
            
        </li>
        
        
        <li id="section-46">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-46">&#182;</a>
              </div>
              <p>Return a JS array given a TypedArray</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">typedToJS</span>: <span class="hljs-function"><span class="hljs-params">(typedArray)</span> -&gt;</span> (i <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> typedArray)</pre></div></div>
            
        </li>
        
        
        <li id="section-47">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-47">&#182;</a>
              </div>
              <p>Return an array with values in [0,norm], defaults to [0,1).
Note: to have a half-open interval, [0,norm), use something like norm-.00009</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">normalize</span>: <span class="hljs-function"><span class="hljs-params">(array, norm=<span class="hljs-number">.999999999</span>)</span> -&gt;</span>
    min = <span class="hljs-property">@aMin</span> array; scale = (norm)/(<span class="hljs-property">@aMax</span>(array) - min)
    (num-min)*scale <span class="hljs-keyword">for</span> num <span class="hljs-keyword">in</span> array</pre></div></div>
            
        </li>
        
        
        <li id="section-48">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-48">&#182;</a>
              </div>
              <p>Binary search of a sorted array, adapted from <a href="http://goo.gl/ozAZH">jaskenas</a>.
Search for index of value with items array, using fcn for item value.
Return -1 if not found.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">binarySearch</span>: <span class="hljs-function"><span class="hljs-params">(items, value, fcn = (ex) -&gt; ex)</span> -&gt;</span>
    start = <span class="hljs-number">0</span>
    stop  = items.length - <span class="hljs-number">1</span>
    pivot = Math.floor (start + stop) / <span class="hljs-number">2</span>
    <span class="hljs-keyword">while</span> (pivotVal = fcn(items[pivot])) <span class="hljs-keyword">isnt</span> value <span class="hljs-keyword">and</span> start &lt; stop
      stop  = pivot - <span class="hljs-number">1</span> <span class="hljs-keyword">if</span> value &lt; pivotVal  <span class="hljs-comment"># Adjust the search area.</span>
      start = pivot + <span class="hljs-number">1</span> <span class="hljs-keyword">if</span> value &gt; pivotVal
      pivot = Math.floor (stop + start) / <span class="hljs-number">2</span>  <span class="hljs-comment"># Recalculate the pivot.</span>
    <span class="hljs-keyword">if</span> fcn(items[pivot]) <span class="hljs-keyword">is</span> value <span class="hljs-keyword">then</span> pivot <span class="hljs-keyword">else</span> -<span class="hljs-number">1</span></pre></div></div>
            
        </li>
        
        
        <li id="section-49">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-49">&#182;</a>
              </div>
              <h3 id="topology-operations">Topology Operations</h3>

            </div>
            
        </li>
        
        
        <li id="section-50">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-50">&#182;</a>
              </div>
              <p>Return angle in (-pi,pi] radians from x1,y1 to x2,y2.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">radsToward</span>: <span class="hljs-function"><span class="hljs-params">(x1, y1, x2, y2)</span> -&gt;</span> 
    PI = Math.PI; dx = x2-x1; dy = y2-y1
    <span class="hljs-keyword">if</span> dx <span class="hljs-keyword">is</span> <span class="hljs-number">0</span> <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> <span class="hljs-number">3</span>*PI/<span class="hljs-number">2</span> <span class="hljs-keyword">if</span> dy &lt; <span class="hljs-number">0</span>; <span class="hljs-keyword">return</span> PI/<span class="hljs-number">2</span> <span class="hljs-keyword">if</span> dy &gt; <span class="hljs-number">0</span>; <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">return</span> Math.atan(dy/dx) + <span class="hljs-keyword">if</span> dx &lt; <span class="hljs-number">0</span> <span class="hljs-keyword">then</span> PI <span class="hljs-keyword">else</span> <span class="hljs-number">0</span></pre></div></div>
            
        </li>
        
        
        <li id="section-51">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-51">&#182;</a>
              </div>
              <p>Return true if x2,y2 is in cone radians around heading radians from x1,x2
and within distance radius from x1,x2.
I.e. is p2 in cone/heading/radius from p1</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">inCone</span>: <span class="hljs-function"><span class="hljs-params">(heading, cone, radius, x1, y1, x2, y2)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> radius &lt; <span class="hljs-property">@distance</span> x1, y1, x2, y2 <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
    angle12 = <span class="hljs-property">@radsToward</span> x1, y1, x2, y2 <span class="hljs-comment"># angle from 1 to 2</span>
    cone/<span class="hljs-number">2</span> &gt;=Math.abs <span class="hljs-property">@subtractRads</span>(heading, angle12)</pre></div></div>
            
        </li>
        
        
        <li id="section-52">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-52">&#182;</a>
              </div>
              <p>Return the Euclidean distance and distance squared between x1,y1, x2,y2.
The squared distance is used for comparisons to avoid the Math.sqrt fcn.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">distance</span>: <span class="hljs-function"><span class="hljs-params">(x1, y1, x2, y2)</span> -&gt;</span> dx = x1-x2; dy = y1-y2; Math.sqrt dx*dx + dy*dy
  <span class="hljs-attribute">sqDistance</span>: <span class="hljs-function"><span class="hljs-params">(x1, y1, x2, y2)</span> -&gt;</span> dx = x1-x2; dy = y1-y2; dx*dx + dy*dy</pre></div></div>
            
        </li>
        
        
        <li id="section-53">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-53">&#182;</a>
              </div>
              <p>Return the <a href="http://goo.gl/PgJ5N">torus distance</a> and distance squared
between two points A(x1,y1) and B(x2,y2):</p>
<pre><code>dx = |x2-x1|; dy = |y2-y1|
d=sqrt(min(dx, W-dx)^<span class="hljs-number">2</span> + min(dy, H-dy)^<span class="hljs-number">2</span>)
</code></pre><p>Torus note: ABMs often use a Torus topology where the right and left edges
fold to meet,and similarly for the top/bottom.
For points, this is easily handled with the mod function .. insuring the
point is within the rectangle modulo W &amp; H.</p>
<p>The relationship <em>between</em> points is more difficult.  The relationship between
A and B must also include the towards-reflections around A, thus 4 points.</p>
<pre><code>     |               |
     |      W        |
-----+---------------+-----
 B1  |           B   |
     |               |  H
     |               |
     |  A            |
-----+---------------+-----
 B3  |           B2  |
     |               |
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">torusDistance</span>: <span class="hljs-function"><span class="hljs-params">(x1, y1, x2, y2, w, h)</span> -&gt;</span> 
    Math.sqrt <span class="hljs-property">@torusSqDistance</span> x1, y1, x2, y2, w, h
  <span class="hljs-attribute">torusSqDistance</span>: <span class="hljs-function"><span class="hljs-params">(x1, y1, x2, y2, w, h)</span> -&gt;</span>
    dx = Math.abs x2-x1; dy = Math.abs y2-y1
    dxMin = Math.min dx, w-dx; dyMin = Math.min dy, h-dy
    dxMin*dxMin + dyMin*dyMin</pre></div></div>
            
        </li>
        
        
        <li id="section-54">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-54">&#182;</a>
              </div>
              <p>Return true if closest path between x1,y1 &amp; x2,y2 wraps around the torus.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">torusWraps</span>: <span class="hljs-function"><span class="hljs-params">(x1, y1, x2, y2, w, h)</span> -&gt;</span>
    dx = Math.abs x2-x1; dy = Math.abs y2-y1
    dx &gt; w-dx <span class="hljs-keyword">or</span> dy &gt; h-dy</pre></div></div>
            
        </li>
        
        
        <li id="section-55">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-55">&#182;</a>
              </div>
              <p>Return 4 torus point reflections of x2,y2 around x1,y1</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">torus4Pts</span>: <span class="hljs-function"><span class="hljs-params">(x1, y1, x2, y2, w, h)</span> -&gt;</span>
    x2r = <span class="hljs-keyword">if</span> x2&lt;x1 <span class="hljs-keyword">then</span> x2+w <span class="hljs-keyword">else</span> x2-w
    y2r = <span class="hljs-keyword">if</span> y2&lt;y1 <span class="hljs-keyword">then</span> y2+h <span class="hljs-keyword">else</span> y2-h
    [ [x2,y2], [x2r,y2], [x2,y2r], [x2r,y2r] ]</pre></div></div>
            
        </li>
        
        
        <li id="section-56">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-56">&#182;</a>
              </div>
              <p>Return closest of 4 torus pts from A to B</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">torusPt</span>: <span class="hljs-function"><span class="hljs-params">(x1, y1, x2, y2, w, h)</span> -&gt;</span>
    x2r = <span class="hljs-keyword">if</span> x2&lt;x1 <span class="hljs-keyword">then</span> x2+w <span class="hljs-keyword">else</span> x2-w
    y2r = <span class="hljs-keyword">if</span> y2&lt;y1 <span class="hljs-keyword">then</span> y2+h <span class="hljs-keyword">else</span> y2-h
    x = <span class="hljs-keyword">if</span> Math.abs(x2r-x1) &lt; Math.abs(x2-x1) <span class="hljs-keyword">then</span> x2r <span class="hljs-keyword">else</span> x2
    y = <span class="hljs-keyword">if</span> Math.abs(y2r-y1) &lt; Math.abs(y2-y1) <span class="hljs-keyword">then</span> y2r <span class="hljs-keyword">else</span> y2
    [x,y]</pre></div></div>
            
        </li>
        
        
        <li id="section-57">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-57">&#182;</a>
              </div>
              <p>Return the angle from x1,y1 to x2.y2 on torus using shortest reflection.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">torusRadsToward</span>: <span class="hljs-function"><span class="hljs-params">(x1, y1, x2, y2, w, h)</span> -&gt;</span> 
    [x2,y2] = <span class="hljs-property">@torusPt</span> x1, y1, x2, y2, w, h
    <span class="hljs-property">@radsToward</span> x1, y1, x2, y2</pre></div></div>
            
        </li>
        
        
        <li id="section-58">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-58">&#182;</a>
              </div>
              <p>Return true if x2,y2 is in cone radians around heading radians from x1,x2
and within distance radius from x1,x2 considering all torus reflections.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">inTorusCone</span>: <span class="hljs-function"><span class="hljs-params">(heading, cone, radius, x1, y1, x2, y2, w, h)</span> -&gt;</span>
    <span class="hljs-keyword">for</span> p <span class="hljs-keyword">in</span> <span class="hljs-property">@torus4Pts</span> x1, y1, x2, y2, w, h
      <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span> <span class="hljs-keyword">if</span> <span class="hljs-property">@inCone</span> heading, cone, radius, x1, y1, p[<span class="hljs-number">0</span>], p[<span class="hljs-number">1</span>]
    <span class="hljs-literal">false</span></pre></div></div>
            
        </li>
        
        
        <li id="section-59">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-59">&#182;</a>
              </div>
              <h3 id="file-i-o">File I/O</h3>

            </div>
            
        </li>
        
        
        <li id="section-60">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-60">&#182;</a>
              </div>
              <p>Cache of file names used by file imports below</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">fileIndex</span>: {}</pre></div></div>
            
        </li>
        
        
        <li id="section-61">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-61">&#182;</a>
              </div>
              <p>Import an image, executing (async) optional function f(img) on completion</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">importImage</span>: <span class="hljs-function"><span class="hljs-params">(name, f)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> (img=<span class="hljs-property">@fileIndex</span>[name])? <span class="hljs-keyword">or</span> ((img=name).width <span class="hljs-keyword">and</span> img.height)
      f(img) <span class="hljs-keyword">if</span> f?
    <span class="hljs-keyword">else</span>
      img = <span class="hljs-keyword">new</span> Image()
      (img.<span class="hljs-function"><span class="hljs-title">onload</span> = -&gt;</span> f(img)) <span class="hljs-keyword">if</span> f?
      img.src = name
      <span class="hljs-property">@fileIndex</span>[name] = img
    img</pre></div></div>
            
        </li>
        
        
        <li id="section-62">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-62">&#182;</a>
              </div>
              <p>Use XMLHttpRequest to fetch data of several types.
Data Types: text, arraybuffer, blob, json, document, <a href="http://goo.gl/y3r3h">Specification:</a></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">xhrLoadFile</span>: <span class="hljs-function"><span class="hljs-params">(name, type=<span class="hljs-string">"text"</span>, f)</span> -&gt;</span> <span class="hljs-comment"># AJAX request, sync if f is null</span>
    <span class="hljs-keyword">if</span> (xhr=<span class="hljs-property">@fileIndex</span>[name])?
      f(xhr.response) <span class="hljs-keyword">if</span> f?
    <span class="hljs-keyword">else</span>
      xhr = <span class="hljs-keyword">new</span> XMLHttpRequest()
      xhr.open <span class="hljs-string">"GET"</span>, name, f?
      xhr.responseType = type
      (xhr.<span class="hljs-function"><span class="hljs-title">onload</span> = -&gt;</span> f(xhr.response)) <span class="hljs-keyword">if</span> f?
      xhr.send()
      <span class="hljs-property">@fileIndex</span>[name] = xhr
    xhr</pre></div></div>
            
        </li>
        
        
        <li id="section-63">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-63">&#182;</a>
              </div>
              <h3 id="canvas-context-operations">Canvas/Context Operations</h3>

            </div>
            
        </li>
        
        
        <li id="section-64">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-64">&#182;</a>
              </div>
              <p>Create a new canvas of given width/height</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">createCanvas</span>: <span class="hljs-function"><span class="hljs-params">(width, height)</span> -&gt;</span>
    can = <span class="hljs-built_in">document</span>.createElement <span class="hljs-string">'canvas'</span>
    can.width = width; can.height = height
    can</pre></div></div>
            
        </li>
        
        
        <li id="section-65">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-65">&#182;</a>
              </div>
              <p>As above, but returing the context object.
Note ctx.canvas is the canvas for the ctx, and can be use as an image.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">createCtx</span>: <span class="hljs-function"><span class="hljs-params">(width, height, ctxType=<span class="hljs-string">"2d"</span>)</span> -&gt;</span>
    can = <span class="hljs-property">@createCanvas</span> width, height
    <span class="hljs-keyword">if</span> ctxType <span class="hljs-keyword">is</span> <span class="hljs-string">"2d"</span> 
    <span class="hljs-keyword">then</span> can.getContext <span class="hljs-string">"2d"</span> 
    <span class="hljs-keyword">else</span> can.getContext(<span class="hljs-string">"webgl"</span>) ? can.getContext(<span class="hljs-string">"experimental-webgl"</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-66">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-66">&#182;</a>
              </div>
              <p>Return a “layer” 2D/3D rendering context within the specified HTML <code>&lt;div&gt;</code>,
with the given width/height positioned absolutely at top/left within the div,
and with the z-index of z.</p>
<p>The z level gives us the capability of buildng a “stack” of coordinated canvases.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">createLayer</span>: <span class="hljs-function"><span class="hljs-params">(div, width, height, z, ctx = <span class="hljs-string">"2d"</span>)</span> -&gt;</span> <span class="hljs-comment"># a canvas ctx object</span>
    ctx = <span class="hljs-property">@createCtx</span> width, height, ctx
    ctx.canvas.setAttribute <span class="hljs-string">'style'</span>, <span class="hljs-string">"position:absolute;top:0;left:0;z-index:<span class="hljs-subst">#{z}</span>"</span>
    <span class="hljs-built_in">document</span>.getElementById(div).appendChild(ctx.canvas)
    ctx</pre></div></div>
            
        </li>
        
        
        <li id="section-67">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-67">&#182;</a>
              </div>
              <p>Install identity transform.  Call ctx.restore() to revert to previous transform</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">setIdentity</span>: <span class="hljs-function"><span class="hljs-params">(ctx)</span> -&gt;</span>
    ctx.save() <span class="hljs-comment"># revert to native 2D transform</span>
    ctx.setTransform <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span></pre></div></div>
            
        </li>
        
        
        <li id="section-68">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-68">&#182;</a>
              </div>
              <p>Clear the 2D/3D layer to be transparent. Note this <a href="http://goo.gl/qekXS">discussion</a>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">clearCtx</span>: <span class="hljs-function"><span class="hljs-params">(ctx)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> ctx.save? <span class="hljs-comment"># test for 2D ctx</span>
      <span class="hljs-property">@setIdentity</span> ctx <span class="hljs-comment"># ctx.canvas.width = ctx.canvas.width not used so as to preserve patch coords</span>
      ctx.clearRect <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, ctx.canvas.width, ctx.canvas.height
      ctx.restore()
    <span class="hljs-keyword">else</span> <span class="hljs-comment"># 3D</span>
      ctx.clearColor <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span> <span class="hljs-comment"># transparent!</span>
      ctx.clear ctx.COLOR_BUFFER_BIT | ctx.DEPTH_BUFFER_BIT</pre></div></div>
            
        </li>
        
        
        <li id="section-69">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-69">&#182;</a>
              </div>
              <p>Fill the 2D/3D layer with the given color</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">fillCtx</span>: <span class="hljs-function"><span class="hljs-params">(ctx, color)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> ctx.fillStyle? <span class="hljs-comment"># test for 2D ctx</span>
      <span class="hljs-property">@setIdentity</span> ctx
      ctx.fillStyle = <span class="hljs-property">@colorStr</span>(color)
      ctx.fillRect <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, ctx.canvas.width, ctx.canvas.height
      ctx.restore()
    <span class="hljs-keyword">else</span> <span class="hljs-comment"># 3D</span>
      ctx.clearColor color..., <span class="hljs-number">1</span> <span class="hljs-comment"># alpha = 1 unless color is rgba</span>
      ctx.clear ctx.COLOR_BUFFER_BIT | ctx.DEPTH_BUFFER_BIT</pre></div></div>
            
        </li>
        
        
        <li id="section-70">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-70">&#182;</a>
              </div>
              <p>Draw string of the given color at the xy location.
Note that this will follow the existing transform.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">ctxDrawText</span>: <span class="hljs-function"><span class="hljs-params">(ctx, string, xy, color = [<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>])</span> -&gt;</span> 
    ctx.fillStyle = <span class="hljs-property">@colorStr</span> color
    ctx.fillText(string, xy[<span class="hljs-number">0</span>], xy[<span class="hljs-number">1</span>])</pre></div></div>
            
        </li>
        
        
        <li id="section-71">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-71">&#182;</a>
              </div>
              <p>Set the canvas text align and baseline drawing parameters</p>
<ul>
<li>font is a HTML/CSS string like: “9px sans-serif”</li>
<li>align is left right center start end</li>
<li>baseline is top hanging middle alphabetic ideographic bottom</li>
</ul>
<p>See <a href="http://goo.gl/AvEAq">reference</a> for details.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">ctxTextParams</span>: <span class="hljs-function"><span class="hljs-params">(ctx, font, align = <span class="hljs-string">"center"</span>, baseline = <span class="hljs-string">"middle"</span>)</span> -&gt;</span> 
    ctx.font = font; ctx.textAlign = align; ctx.textBaseline = baseline</pre></div></div>
            
        </li>
        
        
        <li id="section-72">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-72">&#182;</a>
              </div>
              <p>2D: Store the default color and xy offset for text labels for agentsets.
This is simply using the ctx object for convenient storage.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">ctxLabelParams</span>: <span class="hljs-function"><span class="hljs-params">(ctx, color, xy)</span> -&gt;</span> <span class="hljs-comment"># patches/agents defaults</span>
    ctx.labelColor = color; ctx.labelXY = xy</pre></div></div>
            
        </li>
        
        
        <li id="section-73">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-73">&#182;</a>
              </div>
              <p>Convert an image to a context. ctx.canvas gives the created canvas.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">imageToCtx</span>: <span class="hljs-function"><span class="hljs-params">(image)</span> -&gt;</span>
    ctx = <span class="hljs-property">@createCtx</span> image.width, image.height
    ctx.drawImage image, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>
    ctx</pre></div></div>
            
        </li>
        
        
        <li id="section-74">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-74">&#182;</a>
              </div>
              <p>Convert a context to an image, executing function f on completion.
Generally can skip callback but see <a href="http://goo.gl/kIk2U">stackoverflow</a>
Note: uses toDataURL thus possible cross origin problems.
Fix: use ctx.canvas for programatic imaging.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">ctxToImage</span>: <span class="hljs-function"><span class="hljs-params">(ctx, f)</span> -&gt;</span>
    img = <span class="hljs-keyword">new</span> Image()
    (img.<span class="hljs-function"><span class="hljs-title">onload</span> = -&gt;</span> f(img)) <span class="hljs-keyword">if</span> f?
    img.src = ctx.canvas.toDataURL <span class="hljs-string">"image/png"</span></pre></div></div>
            
        </li>
        
        
        <li id="section-75">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-75">&#182;</a>
              </div>
              <p>Convert a ctx to an imageData object</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">ctxToImageData</span>: <span class="hljs-function"><span class="hljs-params">(ctx)</span> -&gt;</span> ctx.getImageData <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, ctx.canvas.width, ctx.canvas.height</pre></div></div>
            
        </li>
        
        
        <li id="section-76">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-76">&#182;</a>
              </div>
              <p>Canvas versions of above</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">canvasToImage</span>: <span class="hljs-function"><span class="hljs-params">(canvas)</span> -&gt;</span> ctxToImage(canvas.getContext <span class="hljs-string">"2d"</span>)
  <span class="hljs-attribute">canvasToImageData</span>: <span class="hljs-function"><span class="hljs-params">(canvas)</span> -&gt;</span> ctxToImageData(canvas.getContext <span class="hljs-string">"2d"</span>)
  <span class="hljs-attribute">imageToCanvas</span>: <span class="hljs-function"><span class="hljs-params">(image)</span> -&gt;</span> imageToCtx(image).canvas</pre></div></div>
            
        </li>
        
        
        <li id="section-77">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-77">&#182;</a>
              </div>
              <p>Draw an image centered at x, y w/ image size dx, dy.
See <a href="http://goo.gl/VUlhY">this tutorial</a>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">drawCenteredImage</span>: <span class="hljs-function"><span class="hljs-params">(ctx, img, rad, x, y, dx, dy)</span> -&gt;</span> <span class="hljs-comment"># presume save/restore surrounds this</span>
    ctx.translate x, y <span class="hljs-comment"># translate to center</span>
    ctx.rotate rad
    ctx.drawImage img, -dx/<span class="hljs-number">2</span>, -dy/<span class="hljs-number">2</span></pre></div></div>
            
        </li>
        
        
        <li id="section-78">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-78">&#182;</a>
              </div>
              <p>Duplicate a ctx’s image.  Returns the new ctx, use ctx.canvas for canvas.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">copyCtx</span>: <span class="hljs-function"><span class="hljs-params">(ctx0)</span> -&gt;</span>
    ctx = <span class="hljs-property">@createCtx</span> ctx0.canvas.width, ctx0.canvas.height
    ctx.drawImage ctx0.canvas, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>
    ctx</pre></div></div>
            
        </li>
        
        
        <li id="section-79">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-79">&#182;</a>
              </div>
              <p>Resize a ctx/canvas and preserve data.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">resizeCtx</span>: <span class="hljs-function"><span class="hljs-params">(ctx, width, height, scale = <span class="hljs-literal">false</span>)</span> -&gt;</span> <span class="hljs-comment"># http://goo.gl/Tp90B</span>
    copy = <span class="hljs-property">@copyCtx</span> ctx
    ctx.canvas.width = width; ctx.canvas.height = height
    ctx.drawImage copy.canvas, <span class="hljs-number">0</span>, <span class="hljs-number">0</span></pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
